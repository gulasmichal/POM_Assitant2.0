<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POM Assistant 2.0 | SAP Ariba</title>
    <link rel="icon" type="image/png" href="sap-icon.png">
    
    <!-- SheetJS for Excel parsing (client-side) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* ========================================
           SAP FIORI HORIZON DESIGN TOKENS
           ======================================== */
        :root {
            --sapBrandColor: #0070F2;
            --sapPrimaryColor: #0070F2;
            --sapBackgroundColor: #F5F6F7;
            --sapShellColor: #354A5F;
            --sapSurfaceColor: #FFFFFF;
            --sapTextColor: #32363A;
            --sapContent_LabelColor: #6A6D70;
            --sapTitleColor: #32363A;
            --sapShell_TextColor: #FFFFFF;
            --sapNegativeColor: #BB0000;
            --sapCriticalColor: #E9730C;
            --sapPositiveColor: #107E3E;
            --sapInformationColor: #0070F2;
            --sapButton_Background: #0070F2;
            --sapButton_Hover_Background: #0064D9;
            --sapButton_TextColor: #FFFFFF;
            --sapTile_BorderRadius: 12px;
            --sapTile_BoxShadow: 0 0 2px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.1);
            --sapShell_Height: 48px;
            --sapContent_MaxWidth: 1200px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "72", "72full", "72-Web", Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--sapBackgroundColor);
            min-height: 100vh;
        }

        /* ========================================
           SHELL BAR
           ======================================== */
        .fiori-shell {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--sapShell_Height);
            background-color: var(--sapShellColor);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .shell-logo {
            display: flex;
            align-items: center;
        }

        .sap-logo {
            height: 40px;
            width: auto;
        }

        .shell-title {
            color: var(--sapShell_TextColor);
            font-size: 1rem;
            font-weight: 400;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .shell-badge {
            background: var(--sapPositiveColor);
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 600;
        }

        .shell-user {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .shell-avatar {
            width: 32px;
            height: 32px;
            background-color: #5A7A94;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--sapShell_TextColor);
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* ========================================
           MAIN CONTENT
           ======================================== */
        .fiori-content {
            margin-top: calc(var(--sapShell_Height) + 1rem);
            max-width: var(--sapContent_MaxWidth);
            margin-left: auto;
            margin-right: auto;
            padding: 0 1.5rem 4rem 1.5rem;
        }

        .fiori-page-header {
            margin-bottom: 1.5rem;
        }

        .fiori-page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--sapTitleColor);
            margin: 0 0 0.25rem 0;
        }

        .fiori-page-subtitle {
            font-size: 0.9375rem;
            color: var(--sapContent_LabelColor);
            margin: 0;
        }

        /* ========================================
           PRIVACY BADGE
           ======================================== */
        .privacy-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(16, 126, 62, 0.1);
            color: var(--sapPositiveColor);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .privacy-badge svg {
            width: 16px;
            height: 16px;
        }

        /* ========================================
           UPLOAD CARD
           ======================================== */
        .upload-card {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .upload-zone {
            border: 2px dashed #89919A;
            border-radius: 8px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--sapBrandColor);
            background: rgba(0, 112, 242, 0.02);
        }

        .upload-zone input {
            display: none;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: var(--sapContent_LabelColor);
        }

        .upload-text {
            font-size: 1rem;
            color: var(--sapTextColor);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.875rem;
            color: var(--sapContent_LabelColor);
        }

        /* ========================================
           CARDS & TILES
           ======================================== */
        .fiori-card {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .section-header {
            font-size: 1rem;
            font-weight: 600;
            color: var(--sapTitleColor);
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #E5E5E5;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
        }

        .fiori-info-tile {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            padding: 1rem 1.25rem;
        }

        .fiori-info-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--sapContent_LabelColor);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .fiori-info-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--sapTextColor);
            word-break: break-word;
        }

        /* ========================================
           NUMERIC TILES
           ======================================== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .fiori-numeric-tile {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            padding: 1.25rem;
            text-align: center;
        }

        .fiori-numeric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--sapBrandColor);
            line-height: 1.1;
        }

        .fiori-numeric-label {
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--sapContent_LabelColor);
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        /* ========================================
           STATUS BADGES
           ======================================== */
        .fiori-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .fiori-status-info {
            background-color: rgba(0, 112, 242, 0.12);
            color: var(--sapInformationColor);
        }

        .fiori-status-success {
            background-color: rgba(16, 126, 62, 0.12);
            color: var(--sapPositiveColor);
        }

        .fiori-status-warning {
            background-color: rgba(233, 115, 12, 0.12);
            color: var(--sapCriticalColor);
        }

        /* ========================================
           CONTACT CHIPS
           ======================================== */
        .fiori-contact-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .fiori-contact-chip {
            display: inline-flex;
            align-items: center;
            background: #F0F1F2;
            border-radius: 16px;
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
            color: var(--sapTextColor);
        }

        /* ========================================
           COPYABLE FIELDS
           ======================================== */
        .copyable-field {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .copy-btn-small {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: transparent;
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .copy-btn-small:hover {
            background: #F0F1F2;
            border-color: var(--sapBrandColor);
        }

        .copy-btn-small svg {
            width: 14px;
            height: 14px;
            color: var(--sapContent_LabelColor);
        }

        .copy-btn-small:hover svg {
            color: var(--sapBrandColor);
        }

        .copy-btn-small.copied {
            background: rgba(16, 126, 62, 0.1);
            border-color: var(--sapPositiveColor);
        }

        .copy-btn-small.copied svg {
            color: var(--sapPositiveColor);
        }

        .contacts-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .contacts-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--sapContent_LabelColor);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ========================================
           CODE BLOCK
           ======================================== */
        .code-card {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            overflow: hidden;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #F5F6F7;
            border-bottom: 1px solid #E5E5E5;
        }

        .code-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--sapTitleColor);
        }

        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.5rem 1rem;
            background: var(--sapButton_Background);
            color: var(--sapButton_TextColor);
            border: none;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .copy-btn:hover {
            background: var(--sapButton_Hover_Background);
        }

        .copy-btn.copied {
            background: var(--sapPositiveColor);
        }

        .copy-btn svg {
            width: 14px;
            height: 14px;
        }

        .outlook-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #0078D4 0%, #106EBE 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 120, 212, 0.3);
            margin-top: 1rem;
        }

        .outlook-btn:hover {
            background: linear-gradient(135deg, #106EBE 0%, #005A9E 100%);
            box-shadow: 0 4px 8px rgba(0, 120, 212, 0.4);
            transform: translateY(-1px);
        }

        .outlook-btn:active {
            transform: translateY(0);
        }

        .outlook-btn svg {
            width: 18px;
            height: 18px;
        }

        /* ========================================
           INPUT FIELDS
           ======================================== */
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .input-row {
                grid-template-columns: 1fr;
            }
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-label {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--sapTitleColor);
        }

        .input-field {
            padding: 0.625rem 0.875rem;
            border: 1px solid #89919A;
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--sapTextColor);
            background: var(--sapSurfaceColor);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--sapBrandColor);
            box-shadow: 0 0 0 3px rgba(0, 112, 242, 0.15);
        }

        .input-field::placeholder {
            color: var(--sapContent_LabelColor);
        }

        .code-body {
            padding: 1rem;
            background: #FAFBFC;
            font-family: "Consolas", "Monaco", "Courier New", monospace;
            font-size: 0.8125rem;
            color: var(--sapTextColor);
            line-height: 1.6;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        /* ========================================
           DATA TABLE
           ======================================== */
        .data-table-wrapper {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            overflow: hidden;
        }

        .data-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #F5F6F7;
            border-bottom: 1px solid #E5E5E5;
            cursor: pointer;
        }

        .data-table-header:hover {
            background: #EDEFF0;
        }

        .data-table-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--sapTitleColor);
        }

        .data-table-content {
            display: none;
            overflow-x: auto;
        }

        .data-table-content.expanded {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        .data-table th {
            background: #F5F6F7;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--sapTitleColor);
            border-bottom: 1px solid #E5E5E5;
            white-space: nowrap;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #E5E5E5;
            color: var(--sapTextColor);
        }

        .data-table tr:hover {
            background: #F5F6F7;
        }

        /* ========================================
           EMPTY STATE
           ======================================== */
        .empty-state {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            padding: 4rem 2rem;
            text-align: center;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #E8F4FD 0%, #D6E9FA 100%);
            border-radius: 50%;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-icon svg {
            width: 28px;
            height: 28px;
            color: var(--sapBrandColor);
        }

        .empty-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--sapTitleColor);
            margin-bottom: 0.5rem;
        }

        .empty-text {
            font-size: 0.875rem;
            color: var(--sapContent_LabelColor);
        }

        /* ========================================
           FOOTER
           ======================================== */
        .fiori-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            padding: 0.75rem 1rem;
            background: var(--sapBackgroundColor);
            color: var(--sapContent_LabelColor);
            font-size: 0.8125rem;
            border-top: 1px solid #E5E5E5;
            z-index: 100;
        }

        /* ========================================
           HIDDEN
           ======================================== */
        .hidden {
            display: none !important;
        }

        /* ========================================
           SETTINGS BUTTON
           ======================================== */
        .shell-settings-btn {
            background: transparent;
            border: none;
            color: var(--sapShell_TextColor);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s ease;
        }

        .shell-settings-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .shell-settings-btn svg {
            width: 20px;
            height: 20px;
        }

        /* ========================================
           SETTINGS MODAL
           ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #E5E5E5;
            background: #F5F6F7;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--sapTitleColor);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--sapContent_LabelColor);
            border-radius: 4px;
        }

        .modal-close:hover {
            background: #E5E5E5;
            color: var(--sapTextColor);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid #E5E5E5;
            background: #F5F6F7;
        }

        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #E5E5E5;
            padding-bottom: 0.5rem;
        }

        .settings-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--sapContent_LabelColor);
            border-radius: 6px 6px 0 0;
            transition: all 0.15s ease;
        }

        .settings-tab:hover {
            background: #F0F1F2;
            color: var(--sapTextColor);
        }

        .settings-tab.active {
            background: var(--sapBrandColor);
            color: white;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
        }

        /* Type List */
        .type-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .type-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: #F5F6F7;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .type-item:hover {
            background: #EDEFF0;
        }

        .type-item-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .type-item-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .type-item-badge.info {
            background: rgba(0, 112, 242, 0.12);
            color: var(--sapInformationColor);
        }

        .type-item-badge.success {
            background: rgba(16, 126, 62, 0.12);
            color: var(--sapPositiveColor);
        }

        .type-item-badge.warning {
            background: rgba(233, 115, 12, 0.12);
            color: var(--sapCriticalColor);
        }

        .type-item-name {
            font-weight: 500;
            color: var(--sapTextColor);
        }

        .type-item-id {
            font-size: 0.8125rem;
            color: var(--sapContent_LabelColor);
        }

        .type-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .type-action-btn {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            border: 1px solid #E5E5E5;
            background: white;
            cursor: pointer;
            font-size: 0.8125rem;
            color: var(--sapTextColor);
            transition: all 0.15s ease;
        }

        .type-action-btn:hover {
            border-color: var(--sapBrandColor);
            color: var(--sapBrandColor);
        }

        /* Config Info */
        .config-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .config-info-item {
            background: #F5F6F7;
            padding: 1rem;
            border-radius: 8px;
        }

        .config-info-label {
            font-size: 0.75rem;
            color: var(--sapContent_LabelColor);
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .config-info-value {
            font-weight: 600;
            color: var(--sapTextColor);
        }

        /* Config Actions */
        .config-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .config-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.625rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .config-btn-primary {
            background: var(--sapBrandColor);
            color: white;
            border: none;
        }

        .config-btn-primary:hover {
            background: var(--sapButton_Hover_Background);
        }

        .config-btn-secondary {
            background: white;
            color: var(--sapTextColor);
            border: 1px solid #89919A;
        }

        .config-btn-secondary:hover {
            border-color: var(--sapBrandColor);
            color: var(--sapBrandColor);
        }

        .config-btn-danger {
            background: white;
            color: var(--sapNegativeColor);
            border: 1px solid var(--sapNegativeColor);
        }

        .config-btn-danger:hover {
            background: var(--sapNegativeColor);
            color: white;
        }

        .config-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Type Editor */
        .type-editor {
            display: none;
        }

        .type-editor.active {
            display: block;
        }

        .type-editor-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .type-editor-back {
            padding: 0.5rem;
            background: transparent;
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .type-editor-back:hover {
            background: #F0F1F2;
        }

        .type-editor-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--sapTitleColor);
        }

        .editor-section {
            margin-bottom: 1.5rem;
        }

        .editor-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--sapTitleColor);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #E5E5E5;
        }

        .editor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .editor-field {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .editor-field.full-width {
            grid-column: span 2;
        }

        .editor-label {
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--sapTitleColor);
        }

        .editor-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #89919A;
            border-radius: 6px;
            font-size: 0.875rem;
            color: var(--sapTextColor);
        }

        .editor-input:focus {
            outline: none;
            border-color: var(--sapBrandColor);
            box-shadow: 0 0 0 3px rgba(0, 112, 242, 0.1);
        }

        .editor-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: "Consolas", "Monaco", monospace;
        }

        .editor-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #89919A;
            border-radius: 6px;
            font-size: 0.875rem;
            color: var(--sapTextColor);
            background: white;
        }

        .editor-checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .editor-hint {
            font-size: 0.75rem;
            color: var(--sapContent_LabelColor);
            margin-top: 0.25rem;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #E5E5E5;
            border-top-color: var(--sapBrandColor);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--sapContent_LabelColor);
        }

        /* Config Status Badge */
        .config-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .config-status-loaded {
            background: rgba(16, 126, 62, 0.12);
            color: var(--sapPositiveColor);
        }

        .config-status-local {
            background: rgba(0, 112, 242, 0.12);
            color: var(--sapInformationColor);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading configuration...</div>
    </div>

    <!-- Shell Bar -->
    <header class="fiori-shell">
        <div class="shell-logo">
            <img src="saplogo.png" alt="SAP" class="sap-logo">
        </div>
        <span class="shell-title">POM Assistant 2.0</span>
        <div class="shell-user">
            <button class="shell-settings-btn" onclick="openSettings()" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </button>
            <div class="shell-avatar">PS</div>
        </div>
    </header>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </div>
                <button class="modal-close" onclick="closeSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Type List View -->
                <div id="typeListView">
                    <!-- Config Info -->
                    <div class="config-info">
                        <div class="config-info-item">
                            <div class="config-info-label">Config Version</div>
                            <div class="config-info-value" id="configVersion">-</div>
                        </div>
                        <div class="config-info-item">
                            <div class="config-info-label">Last Modified</div>
                            <div class="config-info-value" id="configLastModified">-</div>
                        </div>
                        <div class="config-info-item">
                            <div class="config-info-label">Monitoring Types</div>
                            <div class="config-info-value" id="configTypeCount">-</div>
                        </div>
                    </div>

                    <!-- Config Actions -->
                    <div class="config-actions" style="margin-bottom: 1.5rem;">
                        <button class="config-btn config-btn-secondary" onclick="exportConfig()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Export Config
                        </button>
                        <button class="config-btn config-btn-secondary" onclick="document.getElementById('importConfigInput').click()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Import Config
                        </button>
                        <input type="file" id="importConfigInput" accept=".json" style="display:none" onchange="importConfig(event)">
                        <button class="config-btn config-btn-secondary" onclick="reloadConfigFromServer()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                            Reload from Server
                        </button>
                        <button class="config-btn config-btn-danger" onclick="resetToDefaults()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Reset to Defaults
                        </button>
                    </div>

                    <!-- Section Title -->
                    <div class="editor-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Monitoring Types</span>
                        <button class="config-btn config-btn-primary" onclick="addNewType()" style="padding: 0.375rem 0.75rem; font-size: 0.8125rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add New
                        </button>
                    </div>

                    <!-- Type List -->
                    <div class="type-list" id="typeList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Type Editor View -->
                <div id="typeEditorView" class="type-editor">
                    <div class="type-editor-header">
                        <button class="type-editor-back" onclick="closeTypeEditor()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"/>
                            </svg>
                        </button>
                        <span class="type-editor-title" id="typeEditorTitle">Edit Type</span>
                    </div>

                    <!-- Basic Settings -->
                    <div class="editor-section">
                        <div class="editor-section-title">Basic Settings</div>
                        <div class="editor-grid">
                            <div class="editor-field">
                                <label class="editor-label">Sheet Name (ID)</label>
                                <input type="text" class="editor-input" id="editorSheetName" placeholder="e.g., PO_Ordering">
                                <span class="editor-hint">Must match the Excel sheet name</span>
                            </div>
                            <div class="editor-field">
                                <label class="editor-label">Display Name</label>
                                <input type="text" class="editor-input" id="editorDisplayName" placeholder="e.g., PO Ordering">
                            </div>
                            <div class="editor-field">
                                <label class="editor-label">Type Label</label>
                                <input type="text" class="editor-input" id="editorTypeLabel" placeholder="e.g., PO">
                                <span class="editor-hint">Short label for metrics display</span>
                            </div>
                            <div class="editor-field">
                                <label class="editor-label">ID Field</label>
                                <select class="editor-select" id="editorIdField">
                                    <option value="UniqueName">UniqueName</option>
                                    <option value="InternalId">InternalId</option>
                                </select>
                            </div>
                            <div class="editor-field">
                                <label class="editor-label">Status Color</label>
                                <select class="editor-select" id="editorStatusColor">
                                    <option value="info">Info (Blue)</option>
                                    <option value="success">Success (Green)</option>
                                    <option value="warning">Warning (Orange)</option>
                                </select>
                            </div>
                            <div class="editor-field">
                                <label class="editor-label">Has Query</label>
                                <div class="editor-checkbox-group">
                                    <input type="checkbox" id="editorHasQuery">
                                    <label for="editorHasQuery">Show AQL query section</label>
                                </div>
                            </div>
                            <div class="editor-field full-width">
                                <label class="editor-label">Description</label>
                                <input type="text" class="editor-input" id="editorDescription" placeholder="Brief description of this monitoring type">
                            </div>
                        </div>
                    </div>

                    <!-- Query Template -->
                    <div class="editor-section">
                        <div class="editor-section-title">AQL Query Template</div>
                        <div class="editor-field">
                            <label class="editor-label">Query</label>
                            <textarea class="editor-input editor-textarea" id="editorQueryTemplate" placeholder="SELECT ... FROM ... WHERE UniqueName IN ({{uniqueNamesList}})"></textarea>
                            <span class="editor-hint">Use {{uniqueNamesList}} for the list of IDs</span>
                        </div>
                    </div>

                    <!-- Email Templates -->
                    <div class="editor-section">
                        <div class="editor-section-title">Email to Customer (Multiple Records)</div>
                        <div class="editor-grid">
                            <div class="editor-field full-width">
                                <label class="editor-label">Subject</label>
                                <input type="text" class="editor-input" id="editorEmailCustomerSubject">
                            </div>
                            <div class="editor-field full-width">
                                <label class="editor-label">Body</label>
                                <textarea class="editor-input editor-textarea" id="editorEmailCustomerBody"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="editor-section">
                        <div class="editor-section-title">Email to Product Specialist (Multiple Records)</div>
                        <div class="editor-grid">
                            <div class="editor-field full-width">
                                <label class="editor-label">Subject</label>
                                <input type="text" class="editor-input" id="editorEmailPSSubject">
                            </div>
                            <div class="editor-field full-width">
                                <label class="editor-label">Body</label>
                                <textarea class="editor-input editor-textarea" id="editorEmailPSBody"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="editor-section">
                        <div class="editor-section-title">Email to Customer (Single Record)</div>
                        <div class="editor-grid">
                            <div class="editor-field full-width">
                                <label class="editor-label">Subject</label>
                                <input type="text" class="editor-input" id="editorEmailCustomerSingleSubject">
                            </div>
                            <div class="editor-field full-width">
                                <label class="editor-label">Body</label>
                                <textarea class="editor-input editor-textarea" id="editorEmailCustomerSingleBody"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="editor-section">
                        <div class="editor-section-title">Email to Product Specialist (Single Record)</div>
                        <div class="editor-grid">
                            <div class="editor-field full-width">
                                <label class="editor-label">Subject</label>
                                <input type="text" class="editor-input" id="editorEmailPSSingleSubject">
                            </div>
                            <div class="editor-field full-width">
                                <label class="editor-label">Body</label>
                                <textarea class="editor-input editor-textarea" id="editorEmailPSSingleBody"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="editor-hint" style="margin-bottom: 1rem;">
                        <strong>Available variables:</strong> {{customerName}}, {{realm}}, {{firstName}}, {{caseNumber}}, {{itsmRef}}, {{uniqueName}}, {{recordCount}}, {{uniqueNamesList}}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="config-btn config-btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="config-btn config-btn-primary" id="saveTypeBtn" onclick="saveTypeChanges()" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="fiori-content">
        <!-- Page Header -->
        <div class="fiori-page-header">
            <h1 class="fiori-page-title">AQL Query Generator</h1>
            <p class="fiori-page-subtitle">Generate AQL queries from SAP Ariba monitoring reports</p>
        </div>

        <!-- Privacy Badge -->
        <div class="privacy-badge">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                <path d="M9 12l2 2 4-4"/>
            </svg>
            100% Private - Data never leaves your browser
        </div>

        <!-- Upload Card -->
        <div class="upload-card">
            <!-- Case Number and ITSM REF Inputs -->
            <div class="input-row">
                <div class="input-group">
                    <label class="input-label" for="caseNumberInput">Case Number</label>
                    <input type="text" id="caseNumberInput" class="input-field" placeholder="e.g., CS20250011256983" oninput="updateEmailPreview()">
                </div>
                <div class="input-group">
                    <label class="input-label" for="itsmRefInput">ITSM Reference</label>
                    <input type="text" id="itsmRefInput" class="input-field" placeholder="e.g., Ref:MSG947716891_yyaB2oN7NHK0O7KVgl" oninput="updateEmailPreview()">
                </div>
            </div>
            
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="fileInput" accept=".xlsx,.xls" multiple>
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="12" y1="18" x2="12" y2="12"/>
                    <polyline points="9 15 12 12 15 15"/>
                </svg>
                <p class="upload-text">Click to upload or drag and drop</p>
                <p class="upload-hint">Supports multiple files of the same type. Drag multiple Excel files to combine them.</p>
                <p class="upload-hint" style="margin-top: 0.25rem; font-size: 0.75rem;">Supported types: PO_Ordering, RC_Processing, CLID_Request_Error, PAY_Sending, CR_Sourcing_Confirming, Stuck_Process_Flow_Projects, Req_Approved_No_PO, Appr_Sbmtd_No_ActAppr, OK2Pay_Empty_Export, Ext_Tax_Failure, INV_Approved</p>
            </div>
        </div>

        <!-- Results Container (hidden by default) -->
        <div id="resultsContainer" class="hidden">
            <!-- Status Badge -->
            <div id="statusBadge"></div>

            <!-- Report Information -->
            <h2 class="section-header">Report Information</h2>
            <div class="info-grid" id="infoGrid"></div>

            <!-- Customer Contacts -->
            <div id="contactsSection" class="hidden">
                <h2 class="section-header">Customer Contacts</h2>
                <div class="fiori-card">
                    <div class="contacts-header">
                        <span class="contacts-label">Email Addresses</span>
                        <button class="copy-btn-small" id="copyContactsBtn" onclick="copyContacts()" title="Copy all contacts">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                    <div class="fiori-contact-list" id="contactsList"></div>
                </div>
            </div>

            <!-- Summary -->
            <h2 class="section-header">Summary</h2>
            <div class="metrics-grid" id="metricsGrid"></div>

            <!-- Query Section -->
            <div id="querySection" class="hidden">
                <h2 class="section-header">Generated AQL Query</h2>
                <div class="code-card">
                    <div class="code-header">
                        <span class="code-title">AQL Query</span>
                        <button class="copy-btn" id="copyBtn" onclick="copyQuery()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                            Copy
                        </button>
                    </div>
                    <pre class="code-body" id="queryCode"></pre>
                </div>
            </div>

            <!-- Email Template Section -->
            <div id="emailSection">
                <h2 class="section-header">Email Template</h2>
                
                <!-- Subject -->
                <div class="fiori-info-tile" style="margin-bottom: 1rem;">
                    <div class="fiori-info-label">Subject</div>
                    <div class="copyable-field">
                        <span class="fiori-info-value" id="emailSubject"></span>
                        <button class="copy-btn-small" id="copySubjectBtn" onclick="copySubject()" title="Copy subject">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Body -->
                <div class="code-card">
                    <div class="code-header">
                        <span class="code-title">Body</span>
                        <button class="copy-btn" id="copyEmailBtn" onclick="copyEmailBody()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                            Copy
                        </button>
                    </div>
                    <pre class="code-body" id="emailBody"></pre>
                </div>
                
                <!-- Open in Outlook Button -->
                <button class="outlook-btn" id="openOutlookBtn" onclick="openInOutlook()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Open in Outlook
                </button>
            </div>

            <!-- Raw Data -->
            <h2 class="section-header">Raw Data</h2>
            <div class="data-table-wrapper">
                <div class="data-table-header" onclick="toggleDataTable()">
                    <span class="data-table-title">View uploaded data</span>
                    <svg id="expandIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="data-table-content" id="dataTableContent">
                    <table class="data-table" id="dataTable"></table>
                </div>
            </div>
        </div>

        <!-- Empty State (shown by default) -->
        <div id="emptyState" class="empty-state">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="12" y1="18" x2="12" y2="12"/>
                    <polyline points="9 15 12 12 15 15"/>
                </svg>
            </div>
            <h2 class="empty-title">Upload Monitoring Files</h2>
            <p class="empty-text">Drag and drop Excel files or click to browse.<br><strong>Select multiple files of the same type to combine them.</strong><br>Supports PO_Ordering, RC_Processing, CLID_Request_Error, PAY_Sending, CR_Sourcing_Confirming, Stuck_Process_Flow_Projects, Req_Approved_No_PO, Appr_Sbmtd_No_ActAppr, OK2Pay_Empty_Export, Ext_Tax_Failure, and INV_Approved reports.</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="fiori-footer">
        Created by Michal Gulas
    </footer>

    <script>
        // ========================================
        // CONFIGURATION MANAGEMENT
        // ========================================
        
        const CONFIG_STORAGE_KEY = 'pom_assistant_config';
        const CONFIG_URL = 'config.json';
        
        let appConfig = null;
        let editingTypeId = null;
        let isNewType = false;

        // Global variables for current session
        let currentQuery = '';
        let currentData = null;
        let currentContacts = '';
        let currentProductSpecialist = '';
        let currentEmailSubject = '';
        let currentEmailBody = '';
        let currentMonitoringType = '';
        let currentCustomerName = '';
        let hasCustomerContacts = false;
        let currentCaseNumber = '';
        let currentItsmRef = '';
        let currentRealm = '';
        let currentRecordCount = 0;
        let currentUniqueNames = [];
        let currentFileCount = 1;
        let currentFirstName = '';

        // Load configuration on startup
        async function loadConfiguration() {
            try {
                // First check localStorage for local overrides
                const localConfig = localStorage.getItem(CONFIG_STORAGE_KEY);
                
                if (localConfig) {
                    appConfig = JSON.parse(localConfig);
                    console.log('Loaded config from localStorage');
                } else {
                    // Fetch from server
                    const response = await fetch(CONFIG_URL);
                    if (!response.ok) throw new Error('Failed to load config.json');
                    appConfig = await response.json();
                    console.log('Loaded config from server');
                }
                
                hideLoading();
                initializeApp();
                
            } catch (error) {
                console.error('Error loading configuration:', error);
                alert('Failed to load configuration. Please check if config.json exists.');
                hideLoading();
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showLoading(text = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            overlay.querySelector('.loading-text').textContent = text;
            overlay.classList.remove('hidden');
        }

        function getKnownMonitoringTypes() {
            return appConfig ? Object.keys(appConfig.monitoringTypes) : [];
        }

        function getTypeConfig(typeId) {
            return appConfig?.monitoringTypes?.[typeId] || null;
        }

        // Initialize app after config is loaded
        function initializeApp() {
            // Set up file upload handlers
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.addEventListener('click', () => fileInput.click());
            
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) processFiles(files);
            });

            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) processFiles(files);
            });

            // Update supported types hint
            updateSupportedTypesHint();
        }

        function updateSupportedTypesHint() {
            const types = getKnownMonitoringTypes();
            const typesList = types.join(', ');
            const hints = document.querySelectorAll('.upload-hint');
            if (hints.length > 1) {
                hints[1].textContent = `Supported types: ${typesList}`;
            }
        }

        // Start loading on page load
        document.addEventListener('DOMContentLoaded', loadConfiguration);

        // Parse a single file and return its data
        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        const sheetNames = workbook.SheetNames;
                        const knownTypes = getKnownMonitoringTypes();
                        let monitoringType = null;
                        let infoData = null;
                        let mainData = null;

                        // Extract Info sheet if available
                        if (sheetNames.includes('Info')) {
                            infoData = XLSX.utils.sheet_to_json(workbook.Sheets['Info'], { header: 1 });
                        }

                        // Detect monitoring type from config
                        for (const type of knownTypes) {
                            if (sheetNames.includes(type)) {
                                mainData = XLSX.utils.sheet_to_json(workbook.Sheets[type]);
                                monitoringType = type;
                                break;
                            }
                        }

                        // Fallback: find first non-Info sheet
                        if (!monitoringType) {
                            for (const sheet of sheetNames) {
                                if (sheet !== 'Info') {
                                    mainData = XLSX.utils.sheet_to_json(workbook.Sheets[sheet]);
                                    monitoringType = sheet;
                                    break;
                                }
                            }
                        }

                        if (!monitoringType || !mainData) {
                            reject(new Error(`Could not detect monitoring type in file: ${file.name}`));
                            return;
                        }

                        resolve({
                            fileName: file.name,
                            monitoringType,
                            infoData,
                            mainData
                        });

                    } catch (error) {
                        reject(new Error(`Error parsing ${file.name}: ${error.message}`));
                    }
                };
                reader.onerror = () => reject(new Error(`Failed to read file: ${file.name}`));
                reader.readAsArrayBuffer(file);
            });
        }

        // Extract info from parsed file's info data
        function extractInfoFromParsed(infoData) {
            const info = { realm: '', customerName: '', productSpecialist: '', dataCenter: '', customerContacts: '' };
            if (!infoData) return info;

            for (const row of infoData) {
                if (row.length >= 2) {
                    const key = String(row[0] || '').trim();
                    const value = String(row[1] || '').trim();
                    
                    if (key === 'Realm') info.realm = value;
                    else if (key === 'Customer Account Name') info.customerName = value;
                    else if (key === 'PSEE Consultant') info.productSpecialist = value;
                    else if (key === 'Data Center') info.dataCenter = value;
                    else if (key === 'Monitoring Contacts') info.customerContacts = value;
                }
            }
            return info;
        }

        // Process multiple Excel files
        async function processFiles(files) {
            try {
                // Parse all files
                const parsedFiles = await Promise.all(files.map(file => parseExcelFile(file)));
                
                if (parsedFiles.length === 0) {
                    alert('No valid files to process.');
                    return;
                }

                // Extract info from all files for validation
                const filesWithInfo = parsedFiles.map(f => ({
                    ...f,
                    info: extractInfoFromParsed(f.infoData)
                }));

                // Get reference values from first file
                const firstFile = filesWithInfo[0];
                const refType = firstFile.monitoringType;
                const refRealm = firstFile.info.realm;
                const refCustomer = firstFile.info.customerName;

                // Validate all files have identical monitoring type, realm, and customer
                const validationErrors = [];
                
                for (let i = 1; i < filesWithInfo.length; i++) {
                    const file = filesWithInfo[i];
                    const errors = [];
                    
                    if (file.monitoringType !== refType) {
                        errors.push(`Monitoring Type: "${file.monitoringType}" (expected "${refType}")`);
                    }
                    if (file.info.realm !== refRealm) {
                        errors.push(`Realm: "${file.info.realm}" (expected "${refRealm}")`);
                    }
                    if (file.info.customerName !== refCustomer) {
                        errors.push(`Customer: "${file.info.customerName}" (expected "${refCustomer}")`);
                    }
                    
                    if (errors.length > 0) {
                        validationErrors.push({
                            fileName: file.fileName,
                            errors: errors
                        });
                    }
                }

                if (validationErrors.length > 0) {
                    let errorMsg = `All files must have the same Monitoring Type, Realm, and Customer!\n\n`;
                    errorMsg += `Reference file: ${firstFile.fileName}\n`;
                    errorMsg += ` Monitoring Type: ${refType}\n`;
                    errorMsg += ` Realm: ${refRealm || '(empty)'}\n`;
                    errorMsg += ` Customer: ${refCustomer || '(empty)'}\n\n`;
                    errorMsg += `Mismatched files:\n`;
                    
                    for (const err of validationErrors) {
                        errorMsg += `\n${err.fileName}:\n`;
                        err.errors.forEach(e => errorMsg += `   ${e}\n`);
                    }
                    
                    alert(errorMsg);
                    return;
                }

                // Combine data from all files
                let combinedMainData = [];
                let combinedInfoData = firstFile.infoData;
                
                for (const parsed of parsedFiles) {
                    combinedMainData = combinedMainData.concat(parsed.mainData);
                }

                // Remove duplicate records based on the configured idField
                const typeConfig = getTypeConfig(refType);
                const idField = typeConfig?.idField || 'UniqueName';
                const seenIds = new Set();
                const deduplicatedData = [];
                
                for (const row of combinedMainData) {
                    const id = row[idField];
                    if (id && !seenIds.has(id)) {
                        seenIds.add(id);
                        deduplicatedData.push(row);
                    } else if (!id) {
                        // Keep rows without the ID field
                        deduplicatedData.push(row);
                    }
                }

                currentData = deduplicatedData;
                currentFileCount = parsedFiles.length;
                displayResults(refType, combinedInfoData, deduplicatedData);

            } catch (error) {
                alert(error.message);
            }
        }

        // Legacy single file processing (kept for compatibility)
        function processFile(file) {
            processFiles([file]);
        }

        // Extract info from Info sheet
        function extractInfo(infoData) {
            const info = {};
            if (!infoData) return info;

            for (const row of infoData) {
                if (row.length >= 2) {
                    const key = String(row[0] || '').trim();
                    const value = String(row[1] || '').trim();
                    
                    if (key === 'Realm') info.realm = value;
                    else if (key === 'PSEE Consultant') info.productSpecialist = value;
                    else if (key === 'Monitoring Contacts') info.customerContacts = value;
                    else if (key === 'Data Center') info.dataCenter = value;
                    else if (key === 'Customer Account Name') info.customerName = value;
                }
            }
            return info;
        }

        // Generate query from template
        function generateQueryFromTemplate(template, uniqueNames) {
            if (!template) return '';
            const namesList = uniqueNames.map(n => `'${n}'`).join(', ');
            return template.replace(/\{\{uniqueNamesList\}\}/g, namesList);
        }

        // Generate email from config templates
        function generateEmailFromConfig(typeConfig, toCustomer, isSingleRecord, variables) {
            if (!typeConfig?.emailTemplates) {
                return { subject: '', body: '' };
            }

            // Select the appropriate template
            let templateKey;
            if (toCustomer && isSingleRecord) {
                templateKey = 'toCustomerSingle';
            } else if (toCustomer && !isSingleRecord) {
                templateKey = 'toCustomer';
            } else if (!toCustomer && isSingleRecord) {
                templateKey = 'toPSSingle';
            } else {
                templateKey = 'toPS';
            }

            const template = typeConfig.emailTemplates[templateKey] || typeConfig.emailTemplates.toCustomer;
            if (!template) {
                return { subject: '', body: '' };
            }

            // Replace variables in template
            let subject = template.subject || '';
            let body = template.body || '';

            // Process all variables
            const vars = {
                customerName: variables.customerName || '',
                realm: variables.realm || '',
                firstName: variables.firstName || 'Product Specialist',
                caseNumber: variables.caseNumber ? variables.caseNumber + ' ' : '',
                itsmRef: variables.itsmRef || '',
                uniqueName: variables.uniqueName || '',
                recordCount: variables.recordCount || 0,
                uniqueNamesList: variables.uniqueNamesList || ''
            };

            // Replace placeholders
            for (const [key, value] of Object.entries(vars)) {
                const regex = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
                subject = subject.replace(regex, value);
                body = body.replace(regex, value);
            }

            // Handle realm in subject - add ", realm X" only if realm exists
            if (vars.realm) {
                subject = subject.replace(/, realm \{\{realm\}\}/g, `, realm ${vars.realm}`);
            } else {
                subject = subject.replace(/, realm \{\{realm\}\}/g, '');
            }

            // Clean up subject - remove double spaces and trim
            subject = subject.replace(/\s+/g, ' ').trim();

            return { subject, body };
        }

        // Extract first name from email address
        function getFirstNameFromEmail(email) {
            if (!email) return 'Product Specialist';
            const localPart = email.split('@')[0];
            const firstName = localPart.split('.')[0];
            return firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
        }

        // Display results
        function displayResults(monitoringType, infoData, mainData) {
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsContainer').classList.remove('hidden');

            const info = extractInfo(infoData);
            const typeConfig = getTypeConfig(monitoringType);

            // Status badge - use config
            const statusBadge = document.getElementById('statusBadge');
            const combinedBadge = currentFileCount > 1 
                ? '<span class="fiori-status fiori-status-success" style="margin-left: 0.5rem;">Combined from ' + currentFileCount + ' files</span>' 
                : '';
            
            const displayName = typeConfig?.displayName || monitoringType.replace(/_/g, ' ');
            const statusColor = typeConfig?.statusColor || 'warning';
            statusBadge.innerHTML = `<span class="fiori-status fiori-status-${statusColor}">${displayName}</span>` + combinedBadge;

            // Store monitoring type, customer name, and realm for email
            currentMonitoringType = monitoringType;
            currentCustomerName = info.customerName || 'Customer Account Name';
            currentRealm = info.realm || '';

            // Store product specialist for copy
            currentProductSpecialist = info.productSpecialist || '';
            
            // Get case number and ITSM ref from inputs
            currentCaseNumber = document.getElementById('caseNumberInput').value.trim();
            currentItsmRef = document.getElementById('itsmRefInput').value.trim();

            // Info grid
            const infoGrid = document.getElementById('infoGrid');
            const psValue = info.productSpecialist || 'N/A';
            const psCopyBtn = info.productSpecialist ? `
                <button class="copy-btn-small" id="copyPsBtn" onclick="copyProductSpecialist()" title="Copy email">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                </button>
            ` : '';
            
            infoGrid.innerHTML = `
                <div class="fiori-info-tile">
                    <div class="fiori-info-label">Realm</div>
                    <div class="fiori-info-value">${info.realm || 'N/A'}</div>
                </div>
                <div class="fiori-info-tile">
                    <div class="fiori-info-label">Product Specialist</div>
                    <div class="copyable-field">
                        <span class="fiori-info-value">${psValue}</span>
                        ${psCopyBtn}
                    </div>
                </div>
                <div class="fiori-info-tile">
                    <div class="fiori-info-label">Data Center</div>
                    <div class="fiori-info-value">${info.dataCenter || 'N/A'}</div>
                </div>
            `;

            // Customer contacts
            const contactsSection = document.getElementById('contactsSection');
            const contactsList = document.getElementById('contactsList');
            hasCustomerContacts = !!info.customerContacts;
            if (info.customerContacts) {
                contactsSection.classList.remove('hidden');
                const contacts = info.customerContacts.split(',').map(c => c.trim());
                currentContacts = contacts.join(', ');
                contactsList.innerHTML = contacts.map(c => `<span class="fiori-contact-chip">${c}</span>`).join('');
            } else {
                contactsSection.classList.add('hidden');
                currentContacts = '';
            }

            // Get unique names using config idField
            const idField = typeConfig?.idField || 'UniqueName';
            const uniqueNames = [...new Set(mainData.map(row => row[idField]).filter(Boolean))];
            const recordCount = uniqueNames.length || mainData.length;
            
            // Store for email preview updates
            currentRecordCount = recordCount;
            currentUniqueNames = uniqueNames;

            // Metrics - use config typeLabel
            const metricsGrid = document.getElementById('metricsGrid');
            const typeLabel = typeConfig?.typeLabel || monitoringType.substring(0, 3).toUpperCase();
            
            // Build metrics HTML - show file count if multiple files were combined
            let metricsHtml = `
                <div class="fiori-numeric-tile">
                    <div class="fiori-numeric-value">${recordCount}</div>
                    <div class="fiori-numeric-label">Total Records</div>
                </div>
                <div class="fiori-numeric-tile">
                    <div class="fiori-numeric-value">${typeLabel}</div>
                    <div class="fiori-numeric-label">Record Type</div>
                </div>
            `;
            
            if (currentFileCount > 1) {
                metricsHtml += `
                <div class="fiori-numeric-tile" style="grid-column: span 2;">
                    <div class="fiori-numeric-value" style="color: var(--sapPositiveColor);">${currentFileCount}</div>
                    <div class="fiori-numeric-label">Files Combined</div>
                </div>
                `;
            }
            
            metricsGrid.innerHTML = metricsHtml;

            // Query section - use config hasQuery
            const querySection = document.getElementById('querySection');
            const queryCode = document.getElementById('queryCode');
            
            if (typeConfig?.hasQuery && typeConfig?.queryTemplate) {
                querySection.classList.remove('hidden');
                currentQuery = generateQueryFromTemplate(typeConfig.queryTemplate, uniqueNames);
                queryCode.textContent = currentQuery;
            } else {
                querySection.classList.add('hidden');
                currentQuery = '';
            }

            // Email template section - use config templates
            const emailSubject = document.getElementById('emailSubject');
            const emailBody = document.getElementById('emailBody');
            currentFirstName = getFirstNameFromEmail(info.productSpecialist);
            const singleUniqueName = uniqueNames.length === 1 ? uniqueNames[0] : '';
            
            const emailTemplate = generateEmailFromConfig(
                typeConfig,
                hasCustomerContacts,
                recordCount === 1,
                {
                    customerName: currentCustomerName,
                    realm: currentRealm,
                    firstName: currentFirstName,
                    caseNumber: currentCaseNumber,
                    itsmRef: currentItsmRef,
                    uniqueName: singleUniqueName,
                    recordCount: recordCount,
                    uniqueNamesList: uniqueNames.map(n => `'${n}'`).join(', ')
                }
            );
            
            currentEmailSubject = emailTemplate.subject;
            currentEmailBody = emailTemplate.body;
            emailSubject.textContent = currentEmailSubject;
            emailBody.textContent = currentEmailBody;

            // Data table
            renderDataTable(mainData);
        }

        // Extract first name from email address
        function getFirstNameFromEmail(email) {
            if (!email) return 'Product Specialist';
            // Extract the part before @ and get the first name (before the dot)
            const localPart = email.split('@')[0];
            const firstName = localPart.split('.')[0];
            // Capitalize first letter
            return firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
        }

        // Generate email template based on type
        function generateEmailTemplate(type, customerName, productSpecialistEmail, hasCustomerContacts, recordCount = 0, uniqueNames = []) {
            const firstName = getFirstNameFromEmail(productSpecialistEmail);
            const greeting = hasCustomerContacts ? 'Hello Team,' : `Hello ${firstName},`;
            const isSingleRecord = recordCount === 1;
            const singleUniqueName = uniqueNames.length === 1 ? uniqueNames[0] : '';
            
            switch(type) {
                case 'PO_Ordering':
                    return generatePOEmail(customerName, greeting, hasCustomerContacts);
                case 'RC_Processing':
                    return generateRCEmail(customerName, greeting, hasCustomerContacts);
                case 'CLID_Request_Error':
                    return generateCLIDEmail(customerName, firstName, hasCustomerContacts);
                case 'PAY_Sending':
                    return generatePAYEmail(customerName, firstName);
                case 'CR_Sourcing_Confirming':
                    return generateCRSourcingConfirmingEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                case 'Stuck_Process_Flow_Projects':
                    return generateStuckProcessFlowProjectsEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                case 'Req_Approved_No_PO':
                    return generateReqApprovedNoPOEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                case 'Appr_Sbmtd_No_ActAppr':
                    return generateApprSbmtdNoActApprEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                case 'OK2Pay_Empty_Export':
                    return generateOK2PayEmptyExportEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                case 'Ext_Tax_Failure':
                    return generateExtTaxFailureEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                case 'INV_Approved':
                    return generateINVApprovedEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                default:
                    return {
                        subject: formatSubject(`Proactive Monitoring - ${type.replace(/_/g, ' ')}`, customerName),
                        body: formatBody(`${greeting}\n\nPlease review the attached monitoring data.`)
                    };
            }
        }

        // Format subject with case number and realm
        function formatSubject(basePart, customerName) {
            const realmPart = currentRealm ? `, realm ${currentRealm}` : '';
            const subjectBase = `PSEE Proactive Monitoring - customer ${customerName}${realmPart} - ${basePart}`;
            return currentCaseNumber ? `${currentCaseNumber} ${subjectBase}` : subjectBase;
        }

        // Format body with ITSM reference
        function formatBody(baseBody) {
            return currentItsmRef ? `${baseBody}\n\n${currentItsmRef}` : baseBody;
        }

        function generatePOEmail(customerName, greeting, hasCustomerContacts) {
            const closing = hasCustomerContacts 
                ? 'If you need further assistance, you are welcome to submit a new support case with SAP Ariba.'
                : 'Please forward this information to the customer. If they need further assistance, they are welcome to submit a new support case with SAP Ariba.';
            
            const bodyContent = `${greeting}

Our Proactive Monitoring queries identified several Ariba purchase orders with status = Ordering.
The cause of this status is:
 lack of response from the ERP side. Please check the status of these POs in your ERP.
 missing trading relationship with supplier in SAP Business Network

${closing}`;
            
            return {
                subject: formatSubject('POs in status = Ordering', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateRCEmail(customerName, greeting, hasCustomerContacts) {
            const closing = hasCustomerContacts 
                ? 'If you need further assistance, you are welcome to submit a new support case with SAP Ariba.'
                : 'Please forward this information to the customer. If they need further assistance, they are welcome to submit a new support case with SAP Ariba.';
            
            const bodyContent = `${greeting}

Our Proactive Monitoring queries identified several Ariba receipts with Processing State = Processing.
These receipts were approved in Ariba and send to the ERP system.

The ERP system rejected the receipts with due to various errors. The errors may be viewed in the Comments section when accessing individual receipts in SAP Ariba Buying & Invoicing.
The list of affected RCs is in the attached Excel file.

Ariba retries 4 times a day to re-send the receipts to ERP until they are successfully processed or the max number of retries is used.
The maximum number of retries is determined by parameter Application.Receiving.MaxRetriesToSendPushFailedReceipts set in your realm.

${closing}`;
            
            return {
                subject: formatSubject('RCs in Processing Status = Processing', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateCLIDEmail(customerName, firstName, hasCustomerContacts) {
            if (hasCustomerContacts) {
                // Email template for when customer contacts are available
                const bodyContent = `Hello Team,

Our proactive monitoring queries identified several Contract Workspaces with a CLID request error.
The list of the affected CWs is in the attached Excel file.

How to review the affected CW: Search > Contract Workspace (Procurement) > search by CW ID

Usual CLID request error types:

ReceivedContractStatusUpdateRequestFailure
ReceivedContractStatusUpdateRequestFailure error indicates that the CSUR was successfully processed without any issue, but 500 (failure) response is returned by ERP meaning the corresponding Contract document was NOT created on ERP side. Reviewing the details (in History), we can see the error is caused by Master data, which means that fix requires client engagement.

SendContractRequestFailureWithContractID
Link: https://support.ariba.com/item/view/KB0409688

ProcessContractStatusUpdateRequestInternalError
Link: https://support.ariba.com/item/view/KB0402285
Missing Document Type attribute when sending a CLID to an external system

This issue is caused by ERP Errors received from your ERP system. You should be able to resolve the issue by adjusting the content of the affected CW with the corresponding object in your ERP.`;
                
                return {
                    subject: formatSubject('CLID Request Error', customerName),
                    body: formatBody(bodyContent)
                };
            } else {
                // Email template for when no customer contacts (send to Product Specialist)
                const bodyContent = `Hello ${firstName},

Our proactive monitoring queries identified several Contract Workspaces with a CLID request error.
The list of the affected CWs is in the attached Excel file.

How to review the affected CW: Search > Contract Workspace (Procurement) > search by CW ID

Usual CLID request error types:

ReceivedContractStatusUpdateRequestFailure
ReceivedContractStatusUpdateRequestFailure error indicates that the CSUR was successfully processed without any issue, but 500 (failure) response is returned by ERP meaning the corresponding Contract document was NOT created on ERP side. Reviewing the details (in History), we can see the error is caused by Master data, which means that fix requires client engagement.

SendContractRequestFailureWithContractID
Link: https://support.ariba.com/item/view/KB0409688

ProcessContractStatusUpdateRequestInternalError
Link: https://support.ariba.com/item/view/KB0402285
Missing Document Type attribute when sending a CLID to an external system

This issue is caused by ERP Errors received from the customer's ERP system. To resolve the issue, we need to notify the customer to check and make necessary corrections. Please notify the customer about the issue. In general, the customer should be able to resolve the issue by adjusting the content of the affected CW with the corresponding object in their ERP.

If you want me to email similar notifications directly to the customer (with you in CC), please update the customer contact for proactive monitoring in PSEE Operational Dashboard.`;
                
                return {
                    subject: formatSubject('CLID Request Error', customerName),
                    body: formatBody(bodyContent)
                };
            }
        }

        function generatePAYEmail(customerName, firstName) {
            const bodyContent = `Hello ${firstName},

Our proactive monitoring queries identified multiple Payments in status Sending. The status is caused by ERP errors & AN errors hence the troubleshooting should be on one-by-one basis.

The list of affected payments is in the attached Excel file.

Please forward the list to the customer.
If they need additional assistance from our side, please have them submit a support case with SAP Ariba.`;
            
            return {
                subject: formatSubject('Payments in status Sending', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateCRSourcingConfirmingEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email for contacts with one CR
                    bodyContent = `Hello Team,

Our proactive monitoring has identified that contract request ${uniqueName} is currently stuck in status Sourcing Confirming.

This issue can occur for various reasons and may require further investigation, including the potential use of the Repair Integration tool.

Please open a new support case with us referencing this contract request ID and its current status. 
Our team will be happy to assist you in resolving the matter promptly.`;
                } else {
                    // Email for contacts with more CRs
                    bodyContent = `Hello Team,

Our proactive monitoring has identified that several CRs are currently stuck in status Sourcing Confirming. The list of the affected CRs is in the attached excel file. 

This issue can occur for various reasons and may require further investigation, including the potential use of the Repair Integration tool.

Please open a new support case with us referencing this contract request ID and its current status. 
Our team will be happy to assist you in resolving the matter promptly.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email for product specialist with one CR
                    bodyContent = `Hello ${firstName},

Our proactive monitoring has identified that contract request ${uniqueName} is currently stuck in status Sourcing Confirming.

This issue can occur for various reasons and may require further investigation, including the potential use of the Repair Integration tool.

Please notify the customer about the occurrence. They are advised to open a new support case with us referencing this contract request ID and its current status. 
Our team will be happy to assist them in resolving the matter promptly.`;
                } else {
                    // Email for product specialist with several CRs
                    bodyContent = `Hello ${firstName},

Our proactive monitoring has identified that several CRs are currently stuck in status Sourcing Confirming. The list of the affected CRs is in the attached excel file. 

This issue can occur for various reasons and may require further investigation, including the potential use of the Repair Integration tool.

Please notify the customer about the occurrence. They are advised to open a new support case with us referencing this contract request ID and its current status. 
Our team will be happy to assist them in resolving the matter promptly.`;
                }
            }
            
            return {
                subject: formatSubject('CR in status Sourcing Confirming', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateStuckProcessFlowProjectsEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email to customer contacts one record
                    bodyContent = `Hello Team,

Our proactive monitoring queries identified SM Process Project ${uniqueName} in status In Process.
All associated questionnaires and tasks are in a compliant state, hence the above WS status seems not to be compliant.

If you need additional assistance, you are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to customer contacts more records
                    bodyContent = `Hello Team,

Our proactive monitoring queries identified several SM Process Projects in status In Process. You can find the affected Projects in the attached excel file.
All associated questionnaires and tasks are in a compliant state, hence the above WS status seems not to be compliant.

If you need additional assistance, you are welcome to submit a support case with SAP Ariba.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email to product specialist one record
                    bodyContent = `Hello ${firstName},

Our proactive monitoring queries identified SM Process Project ${uniqueName} in status In Process.
All associated questionnaires and tasks are in a compliant state, hence the above WS status seems not to be compliant.

Please notify the customer about this occurrence.
If they need additional assistance, they are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to product specialist more records
                    bodyContent = `Hello ${firstName},

Our proactive monitoring queries identified several SM Process Projects in status In Process. You can find the affected Projects in the attached excel file.
All associated questionnaires and tasks are in a compliant state, hence the above WS status seems not to be compliant.

Please notify the customer about this occurrence.
If they need additional assistance, they are welcome to submit a support case with SAP Ariba.`;
                }
            }
            
            return {
                subject: formatSubject('SM Process Projects in status In Process', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateReqApprovedNoPOEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email to customer contacts with one PR
                    bodyContent = `Hello Team,

our proactive monitoring queries identified ${uniqueName} in status Approved.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to customer contacts with more PRs
                    bodyContent = `Hello Team,

our proactive monitoring queries identified several PRs in status Approved.

You can find the list of the PRs in the attached Excel file.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email to PS with one PR
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified ${uniqueName} in status Approved.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to PS with more PRs
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified several PRs in status Approved.

You can find the list of the PRs in the attached Excel file.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                }
            }
            
            return {
                subject: formatSubject('Requisition in status Approved with no PO', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateApprSbmtdNoActApprEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email to customer contacts with one Approvable
                    bodyContent = `Hello Team,

our proactive monitoring queries identified ${uniqueName} in status Submitted without any active approvers in the Approval Flow.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to customer contacts with more Approvables
                    bodyContent = `Hello Team,

our proactive monitoring queries identified several Approvable Objects in status Submitted without any active approvers in the Approval Flow.

You can find the list of the Approvables in the attached Excel file.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email to PS with one Approvable
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified ${uniqueName} in status Submitted without any active approvers in the Approval Flow.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to PS with more Approvables
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified several Approvable Objects in status Submitted without any active approvers in the Approval Flow.

You can find the list of the Approvables in the attached Excel file.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                }
            }
            
            return {
                subject: formatSubject('Approvable object in status Submitted with no active', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateOK2PayEmptyExportEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email to customer contacts with one record
                    bodyContent = `Hello Team,

our proactive monitoring queries identified OK2Pay export ${uniqueName} with 0 records exported.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to customer contacts with more records
                    bodyContent = `Hello Team,

our proactive monitoring queries identified several OK2Pay exports with 0 records exported.

You can find the list of the affected exports in the attached Excel file.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email to PS with one record
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified OK2Pay export ${uniqueName} with 0 records exported.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to PS with more records
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified several OK2Pay exports with 0 records exported.

You can find the list of the affected exports in the attached Excel file.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                }
            }
            
            return {
                subject: formatSubject('OK2Pay Empty Export', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateExtTaxFailureEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email to customer contacts with one IR
                    bodyContent = `Hello Team,

Our proactive monitoring queries identified IR ${uniqueName} in status Awaiting Tax Engine Confirmation.

Based on the documentation https://support.ariba.com/item/view/KB0406386, we see this status is if an error occurs in the response from the tax calculation engine. The IR status remains Awaiting Tax Engine Confirmation until the tax calculation response is received successfully. IR in this status continues to be sent to the third-party tax system every day.

The identified occurrence requires end user attention.

If you need additional assistance with the above occurrence, you are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to customer contacts with more IRs
                    bodyContent = `Hello Team,

Our proactive monitoring queries identified several IRs in status Awaiting Tax Engine Confirmation.

The list of affected IRs is in the attached Excel file.

Based on the documentation https://support.ariba.com/item/view/KB0406386, we see this status is if an error occurs in the response from the tax calculation engine. The IR status remains Awaiting Tax Engine Confirmation until the tax calculation response is received successfully. IR in this status continues to be sent to the third-party tax system every day.

The identified occurrences require end user attention on one-by-one basis.

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email to PS with one IR
                    bodyContent = `Hello ${firstName},

Our proactive monitoring queries identified IR ${uniqueName} in status Awaiting Tax Engine Confirmation.

Based on the documentation https://support.ariba.com/item/view/KB0406386, we see this status is if an error occurs in the response from the tax calculation engine. The IR status remains Awaiting Tax Engine Confirmation until the tax calculation response is received successfully. IR in this status continues to be sent to the third-party tax system every day.

The identified occurrence requires end user attention.

Please notify the customer about the occurrence. If they need additional assistance with the above occurrence, they are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to PS with more IRs
                    bodyContent = `Hello ${firstName},

Our proactive monitoring queries identified several IRs in status Awaiting Tax Engine Confirmation.

The list of affected IRs is in the attached Excel file.

Based on the documentation https://support.ariba.com/item/view/KB0406386, we see this status is if an error occurs in the response from the tax calculation engine. The IR status remains Awaiting Tax Engine Confirmation until the tax calculation response is received successfully. IR in this status continues to be sent to the third-party tax system every day.

The identified occurrences require end user attention on one-by-one basis.

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                }
            }
            
            return {
                subject: formatSubject('External Tax Engine Failure', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateINVApprovedEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email to customer contacts with one invoice
                    bodyContent = `Hello Team,

our proactive monitoring queries found one invoice in status Approved: ${uniqueName}

Insert your investigation !!!!!!!!!!!!!!!

The invoice requires additional technical investigation beyond the scope of proactive monitoring.

If you need additional assistance with the above, you are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to customer contacts with more invoices
                    bodyContent = `Hello Team,

our proactive monitoring queries found several invoices in status Approved.

The list of affected INVs is in the attached Excel file.

Insert your investigation !!!!!!!!!!!!!!!

The invoice requires additional technical investigation beyond the scope of proactive monitoring.

If you need additional assistance with the above, you are welcome to submit a support case with SAP Ariba.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email to PS with one invoice
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries found one invoice in status Approved: ${uniqueName}

Insert your investigation !!!!!!!!!!!!!!!

The invoice requires additional technical investigation beyond the scope of proactive monitoring.

Please notify the customer about the occurrence. If they need additional assistance with the above, they are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to PS with more invoices
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries found several invoices in status Approved.

The list of affected INVs is in the attached Excel file.

Insert your investigation !!!!!!!!!!!!!!!

The invoice requires additional technical investigation beyond the scope of proactive monitoring.

Please notify the customer about the occurrence. If they need additional assistance with the above, they are welcome to submit a support case with SAP Ariba.`;
                }
            }
            
            return {
                subject: formatSubject('Invoice in status Approved', customerName),
                body: formatBody(bodyContent)
            };
        }

        // Update email preview when case number or ITSM ref changes
        function updateEmailPreview() {
            // Only update if results are displayed
            if (document.getElementById('resultsContainer').classList.contains('hidden')) {
                return;
            }
            
            // Get current input values
            currentCaseNumber = document.getElementById('caseNumberInput').value.trim();
            currentItsmRef = document.getElementById('itsmRefInput').value.trim();
            
            // Regenerate email template using config
            const typeConfig = getTypeConfig(currentMonitoringType);
            const singleUniqueName = currentUniqueNames.length === 1 ? currentUniqueNames[0] : '';
            
            const emailTemplate = generateEmailFromConfig(
                typeConfig,
                hasCustomerContacts,
                currentRecordCount === 1,
                {
                    customerName: currentCustomerName,
                    realm: currentRealm,
                    firstName: currentFirstName,
                    caseNumber: currentCaseNumber,
                    itsmRef: currentItsmRef,
                    uniqueName: singleUniqueName,
                    recordCount: currentRecordCount,
                    uniqueNamesList: currentUniqueNames.map(n => `'${n}'`).join(', ')
                }
            );
            
            currentEmailSubject = emailTemplate.subject;
            currentEmailBody = emailTemplate.body;
            
            // Update display
            document.getElementById('emailSubject').textContent = currentEmailSubject;
            document.getElementById('emailBody').textContent = currentEmailBody;
        }

        // Generate AQL query
        function generateQuery(type, uniqueNames, mainData = []) {
            const namesStr = uniqueNames.map(n => `'${n}'`).join(', ');
            
            if (type === 'PO_Ordering') {
                return `SELECT
UniqueName "PO ID Ariba",
OrderID "Order ID SAP",
Name "PO Title",
StatusString "Status",
"Active" "Active",
TimeCreated,
TimeUpdated,
Recipients.OrderingMethod "Ordering Method",
Recipients.State "Recipient State",
Recipients.FailureReason "Failure Reason",
Recipients.TimeCreated "Recipient TimeCreated",
Recipients.TimeUpdated "Recipient TimeUpdated",
Supplier.Name as "Supplier Name",
Supplier.UniqueName as "Supplier ID",
SupplierLocation.PreferredOrderingMethod as SupplierOrderingMethod,
SupplierLocation.EmailAddress as EmailAddress,
SupplierLocation.AribaNetworkId as AribaNetworkId,
this
FROM ariba.purchasing.core.PurchaseOrder
WHERE UniqueName IN (${namesStr})
ORDER BY StatusString, UniqueName, TimeCreated, Recipients.OrderingMethod`;
            } else if (type === 'RC_Processing') {
                return `SELECT DISTINCT UniqueName as "Id",
UniqueName,
StatusString,
CreateDate,
ApprovedDate,
'Awaiting processing' ProcessedStateString
FROM ariba.receiving.core.Receipt
WHERE StatusString = 'Approved'
AND ProcessedState = 1
AND UniqueName IN (${namesStr})
ORDER BY ApprovedDate DESC`;
            } else if (type === 'CR_Sourcing_Confirming') {
                return `SELECT
UniqueName,
StatusString,
TimeCreated,
TimeUpdated,
"Active" "Active",
this
FROM ContractRequest INCLUDE INACTIVE
WHERE UniqueName IN (${namesStr})
ORDER BY TimeCreated`;
            } else if (type === 'Stuck_Process_Flow_Projects') {
                // For Stuck_Process_Flow_Projects, we use InternalId instead of UniqueName
                const internalIds = [...new Set(mainData.map(row => row.InternalId).filter(Boolean))];
                const idsStr = internalIds.map(n => `'${n}'`).join(', ');
                return `SELECT DISTINCT
InternalId AS "Id",
InternalId,
Title,
ProcessFlowStatus,
ProjectAddin.Plan.EndDateTime AS "Plan End Date",
ProjectAddin.Plan.Status AS "Plan Status"
FROM ariba.sourcing.content.SMProcessFlowProject
WHERE ProcessFlowStatus NOT IN ('ConditionallyApproved','PendingDecision','Approved','Denied','Cancelled')
AND InternalId IN (${idsStr})
ORDER BY InternalId`;
            } else if (type === 'OK2Pay_Empty_Export') {
                return `SELECT UniqueName AS "Id",
UniqueName,
StartRunDate,
EndRunDate,
AdapterName,
CurrentTime() AS "QueryDate"
FROM ariba.integration.core.IntegrationEventLog
WHERE AdapterName LIKE '%PaymentExport_CSV'
AND RecordsExported = 0
AND (
  (CurrentTime() - StartRunDate) <= 1 OR
  (CurrentTime() - EndRunDate) <= 1
)
Order by 3 desc`;
            } else if (type === 'Ext_Tax_Failure') {
                return `SELECT
UniqueName,
StatusString,
TimeCreated,
TimeUpdated,
this
FROM InvoiceReconciliation
WHERE UniqueName IN (${namesStr})
ORDER BY TimeCreated`;
            } else {
                return `SELECT DISTINCT UniqueName as "Id",
UniqueName,
StatusString,
CreateDate,
ApprovedDate,
'Awaiting processing' ProcessedStateString
FROM ariba.receiving.core.Receipt
WHERE StatusString = 'Approved'
AND ProcessedState = 1
AND UniqueName IN (${namesStr})
ORDER BY ApprovedDate DESC`;
            }
        }

        // Copy query to clipboard
        function copyQuery() {
            navigator.clipboard.writeText(currentQuery).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.classList.add('copied');
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Copied!
                `;
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        Copy
                    `;
                }, 2000);
            });
        }

        // Copy product specialist to clipboard
        function copyProductSpecialist() {
            if (!currentProductSpecialist) return;
            navigator.clipboard.writeText(currentProductSpecialist).then(() => {
                showCopySuccess('copyPsBtn');
            });
        }

        // Copy email subject to clipboard
        function copySubject() {
            navigator.clipboard.writeText(currentEmailSubject).then(() => {
                showCopySuccess('copySubjectBtn');
            });
        }

        // Copy email body to clipboard
        function copyEmailBody() {
            navigator.clipboard.writeText(currentEmailBody).then(() => {
                const btn = document.getElementById('copyEmailBtn');
                btn.classList.add('copied');
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Copied!
                `;
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        Copy
                    `;
                }, 2000);
            });
        }

        // Copy contacts to clipboard
        function copyContacts() {
            if (!currentContacts) return;
            navigator.clipboard.writeText(currentContacts).then(() => {
                showCopySuccess('copyContactsBtn');
            });
        }

        // Open email in Outlook (mailto)
        function openInOutlook() {
            const notificationEmail = 'itsm.notification-service@sap.com';
            let toRecipients = '';
            let ccRecipients = '';

            if (hasCustomerContacts && currentContacts) {
                // Customer contacts as recipients, PS and notification service in CC
                toRecipients = currentContacts;
                ccRecipients = currentProductSpecialist 
                    ? `${currentProductSpecialist}, ${notificationEmail}`
                    : notificationEmail;
            } else {
                // Product specialist as recipient, notification service in CC
                toRecipients = currentProductSpecialist || '';
                ccRecipients = notificationEmail;
            }

            // Construct mailto URL
            const subject = encodeURIComponent(currentEmailSubject);
            const body = encodeURIComponent(currentEmailBody);
            const cc = encodeURIComponent(ccRecipients);
            
            let mailtoUrl = `mailto:${toRecipients}?subject=${subject}&body=${body}&cc=${cc}`;
            
            // Open the mailto link
            window.location.href = mailtoUrl;
        }

        // Show copy success animation for small buttons
        function showCopySuccess(btnId) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            btn.classList.add('copied');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            `;
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = originalHtml;
            }, 1500);
        }

        // Render data table
        function renderDataTable(data) {
            const table = document.getElementById('dataTable');
            if (!data || data.length === 0) {
                table.innerHTML = '<tr><td>No data available</td></tr>';
                return;
            }

            const headers = Object.keys(data[0]);
            let html = '<thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(h => html += `<td>${row[h] || ''}</td>`);
                html += '</tr>';
            });
            html += '</tbody>';
            
            table.innerHTML = html;
        }

        // Toggle data table
        function toggleDataTable() {
            const content = document.getElementById('dataTableContent');
            const icon = document.getElementById('expandIcon');
            content.classList.toggle('expanded');
            icon.style.transform = content.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0)';
        }

        // ========================================
        // SETTINGS MODAL FUNCTIONS
        // ========================================

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('hidden');
            populateSettingsModal();
            showTypeList();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            editingTypeId = null;
            isNewType = false;
        }

        function populateSettingsModal() {
            // Update config info
            document.getElementById('configVersion').textContent = appConfig?.version || '-';
            document.getElementById('configLastModified').textContent = appConfig?.lastModified || '-';
            document.getElementById('configTypeCount').textContent = Object.keys(appConfig?.monitoringTypes || {}).length;

            // Populate type list
            const typeList = document.getElementById('typeList');
            typeList.innerHTML = '';

            for (const [typeId, typeConfig] of Object.entries(appConfig?.monitoringTypes || {})) {
                const item = document.createElement('div');
                item.className = 'type-item';
                item.innerHTML = `
                    <div class="type-item-info">
                        <span class="type-item-badge ${typeConfig.statusColor}">${typeConfig.typeLabel}</span>
                        <span class="type-item-name">${typeConfig.displayName}</span>
                        <span class="type-item-id">(${typeId})</span>
                    </div>
                    <div class="type-item-actions">
                        <button class="type-action-btn" onclick="editType('${typeId}')">Edit</button>
                    </div>
                `;
                typeList.appendChild(item);
            }
        }

        function showTypeList() {
            document.getElementById('typeListView').style.display = 'block';
            document.getElementById('typeEditorView').classList.remove('active');
            document.getElementById('saveTypeBtn').style.display = 'none';
        }

        function editType(typeId) {
            editingTypeId = typeId;
            isNewType = false;
            const typeConfig = appConfig.monitoringTypes[typeId];

            document.getElementById('typeEditorTitle').textContent = `Edit: ${typeConfig.displayName}`;
            
            // Populate form fields
            document.getElementById('editorSheetName').value = typeId;
            document.getElementById('editorSheetName').disabled = true; // Can't change ID of existing type
            document.getElementById('editorDisplayName').value = typeConfig.displayName || '';
            document.getElementById('editorDescription').value = typeConfig.description || '';
            document.getElementById('editorTypeLabel').value = typeConfig.typeLabel || '';
            document.getElementById('editorIdField').value = typeConfig.idField || 'UniqueName';
            document.getElementById('editorStatusColor').value = typeConfig.statusColor || 'warning';
            document.getElementById('editorHasQuery').checked = typeConfig.hasQuery || false;
            document.getElementById('editorQueryTemplate').value = typeConfig.queryTemplate || '';

            // Email templates
            const templates = typeConfig.emailTemplates || {};
            document.getElementById('editorEmailCustomerSubject').value = templates.toCustomer?.subject || '';
            document.getElementById('editorEmailCustomerBody').value = templates.toCustomer?.body || '';
            document.getElementById('editorEmailPSSubject').value = templates.toPS?.subject || '';
            document.getElementById('editorEmailPSBody').value = templates.toPS?.body || '';
            document.getElementById('editorEmailCustomerSingleSubject').value = templates.toCustomerSingle?.subject || '';
            document.getElementById('editorEmailCustomerSingleBody').value = templates.toCustomerSingle?.body || '';
            document.getElementById('editorEmailPSSingleSubject').value = templates.toPSSingle?.subject || '';
            document.getElementById('editorEmailPSSingleBody').value = templates.toPSSingle?.body || '';

            // Show editor
            document.getElementById('typeListView').style.display = 'none';
            document.getElementById('typeEditorView').classList.add('active');
            document.getElementById('saveTypeBtn').style.display = 'inline-flex';
        }

        function closeTypeEditor() {
            showTypeList();
            editingTypeId = null;
            isNewType = false;
        }

        function saveTypeChanges() {
            const typeId = document.getElementById('editorSheetName').value.trim();
            
            if (!typeId) {
                alert('Sheet Name is required');
                return;
            }

            const updatedType = {
                displayName: document.getElementById('editorDisplayName').value.trim(),
                description: document.getElementById('editorDescription').value.trim(),
                typeLabel: document.getElementById('editorTypeLabel').value.trim(),
                idField: document.getElementById('editorIdField').value,
                statusColor: document.getElementById('editorStatusColor').value,
                hasQuery: document.getElementById('editorHasQuery').checked,
                queryTemplate: document.getElementById('editorQueryTemplate').value,
                emailTemplates: {
                    toCustomer: {
                        subject: document.getElementById('editorEmailCustomerSubject').value,
                        body: document.getElementById('editorEmailCustomerBody').value
                    },
                    toPS: {
                        subject: document.getElementById('editorEmailPSSubject').value,
                        body: document.getElementById('editorEmailPSBody').value
                    },
                    toCustomerSingle: {
                        subject: document.getElementById('editorEmailCustomerSingleSubject').value,
                        body: document.getElementById('editorEmailCustomerSingleBody').value
                    },
                    toPSSingle: {
                        subject: document.getElementById('editorEmailPSSingleSubject').value,
                        body: document.getElementById('editorEmailPSSingleBody').value
                    }
                }
            };

            // Update config
            appConfig.monitoringTypes[typeId] = updatedType;
            appConfig.lastModified = new Date().toISOString().split('T')[0];

            // Save to localStorage
            saveConfigToLocalStorage();

            // Update UI
            populateSettingsModal();
            showTypeList();
            updateSupportedTypesHint();

            alert('Changes saved successfully!');
        }

        function saveConfigToLocalStorage() {
            localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(appConfig));
            console.log('Config saved to localStorage');
        }

        function exportConfig() {
            const dataStr = JSON.stringify(appConfig, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `pom-assistant-config-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedConfig = JSON.parse(e.target.result);
                    
                    // Validate structure
                    if (!importedConfig.monitoringTypes) {
                        throw new Error('Invalid config: missing monitoringTypes');
                    }

                    const typeCount = Object.keys(importedConfig.monitoringTypes).length;
                    if (!confirm(`Import ${typeCount} monitoring types from this config?\n\nThis will replace your current configuration.`)) {
                        return;
                    }

                    appConfig = importedConfig;
                    saveConfigToLocalStorage();
                    populateSettingsModal();
                    updateSupportedTypesHint();
                    
                    alert('Configuration imported successfully!');
                } catch (error) {
                    alert('Error importing config: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset input
            event.target.value = '';
        }

        async function reloadConfigFromServer() {
            if (!confirm('Reload configuration from server?\n\nThis will discard any local changes.')) {
                return;
            }

            try {
                showLoading('Reloading configuration...');
                
                const response = await fetch(CONFIG_URL + '?t=' + Date.now()); // Cache bust
                if (!response.ok) throw new Error('Failed to load config.json');
                
                appConfig = await response.json();
                localStorage.removeItem(CONFIG_STORAGE_KEY); // Clear local overrides
                
                hideLoading();
                populateSettingsModal();
                updateSupportedTypesHint();
                
                alert('Configuration reloaded from server!');
            } catch (error) {
                hideLoading();
                alert('Error reloading config: ' + error.message);
            }
        }

        function resetToDefaults() {
            if (!confirm('Reset to default configuration?\n\nThis will remove all local changes and reload from server.')) {
                return;
            }

            localStorage.removeItem(CONFIG_STORAGE_KEY);
            location.reload();
        }

        // Add new monitoring type
        function addNewType() {
            editingTypeId = null;
            isNewType = true;

            document.getElementById('typeEditorTitle').textContent = 'Add New Monitoring Type';
            
            // Clear form fields
            document.getElementById('editorSheetName').value = '';
            document.getElementById('editorSheetName').disabled = false;
            document.getElementById('editorDisplayName').value = '';
            document.getElementById('editorDescription').value = '';
            document.getElementById('editorTypeLabel').value = '';
            document.getElementById('editorIdField').value = 'UniqueName';
            document.getElementById('editorStatusColor').value = 'warning';
            document.getElementById('editorHasQuery').checked = false;
            document.getElementById('editorQueryTemplate').value = '';

            // Clear email templates
            document.getElementById('editorEmailCustomerSubject').value = '{{caseNumber}} PSEE Proactive Monitoring - customer {{customerName}}, realm {{realm}} - ';
            document.getElementById('editorEmailCustomerBody').value = 'Hello Team,\n\n\n\nIf you need additional assistance, you are welcome to submit a support case with SAP Ariba.\n\n{{itsmRef}}';
            document.getElementById('editorEmailPSSubject').value = '{{caseNumber}} PSEE Proactive Monitoring - customer {{customerName}}, realm {{realm}} - ';
            document.getElementById('editorEmailPSBody').value = 'Hello {{firstName}},\n\n\n\nPlease notify the customer about the occurrence. If they need additional assistance, they are welcome to submit a support case with SAP Ariba.\n\n{{itsmRef}}';
            document.getElementById('editorEmailCustomerSingleSubject').value = '{{caseNumber}} PSEE Proactive Monitoring - customer {{customerName}}, realm {{realm}} - ';
            document.getElementById('editorEmailCustomerSingleBody').value = 'Hello Team,\n\n\n\nIf you need additional assistance, you are welcome to submit a support case with SAP Ariba.\n\n{{itsmRef}}';
            document.getElementById('editorEmailPSSingleSubject').value = '{{caseNumber}} PSEE Proactive Monitoring - customer {{customerName}}, realm {{realm}} - ';
            document.getElementById('editorEmailPSSingleBody').value = 'Hello {{firstName}},\n\n\n\nPlease notify the customer about the occurrence. If they need additional assistance, they are welcome to submit a support case with SAP Ariba.\n\n{{itsmRef}}';

            // Show editor
            document.getElementById('typeListView').style.display = 'none';
            document.getElementById('typeEditorView').classList.add('active');
            document.getElementById('saveTypeBtn').style.display = 'inline-flex';
        }
    </script>
</body>
</html>
