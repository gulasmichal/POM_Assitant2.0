<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POM Assistant 2.0 | SAP Ariba</title>
    <link rel="icon" type="image/png" href="sap-icon.png">
    
    <!-- SheetJS for Excel parsing (client-side) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* ========================================
           SAP FIORI HORIZON DESIGN TOKENS
           ======================================== */
        :root {
            --sapBrandColor: #0070F2;
            --sapPrimaryColor: #0070F2;
            --sapBackgroundColor: #F5F6F7;
            --sapShellColor: #354A5F;
            --sapSurfaceColor: #FFFFFF;
            --sapTextColor: #32363A;
            --sapContent_LabelColor: #6A6D70;
            --sapTitleColor: #32363A;
            --sapShell_TextColor: #FFFFFF;
            --sapNegativeColor: #BB0000;
            --sapCriticalColor: #E9730C;
            --sapPositiveColor: #107E3E;
            --sapInformationColor: #0070F2;
            --sapButton_Background: #0070F2;
            --sapButton_Hover_Background: #0064D9;
            --sapButton_TextColor: #FFFFFF;
            --sapTile_BorderRadius: 12px;
            --sapTile_BoxShadow: 0 0 2px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.1);
            --sapShell_Height: 48px;
            --sapContent_MaxWidth: 1200px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "72", "72full", "72-Web", Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--sapBackgroundColor);
            min-height: 100vh;
        }

        /* ========================================
           SHELL BAR
           ======================================== */
        .fiori-shell {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--sapShell_Height);
            background-color: var(--sapShellColor);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .shell-logo {
            display: flex;
            align-items: center;
        }

        .sap-logo {
            height: 40px;
            width: auto;
        }

        .shell-title {
            color: var(--sapShell_TextColor);
            font-size: 1rem;
            font-weight: 400;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .shell-badge {
            background: var(--sapPositiveColor);
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 600;
        }

        .shell-user {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .shell-avatar {
            width: 32px;
            height: 32px;
            background-color: #5A7A94;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--sapShell_TextColor);
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* ========================================
           MAIN CONTENT
           ======================================== */
        .fiori-content {
            margin-top: calc(var(--sapShell_Height) + 1rem);
            max-width: var(--sapContent_MaxWidth);
            margin-left: auto;
            margin-right: auto;
            padding: 0 1.5rem 4rem 1.5rem;
        }

        .fiori-page-header {
            margin-bottom: 1.5rem;
        }

        .fiori-page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--sapTitleColor);
            margin: 0 0 0.25rem 0;
        }

        .fiori-page-subtitle {
            font-size: 0.9375rem;
            color: var(--sapContent_LabelColor);
            margin: 0;
        }

        /* ========================================
           PRIVACY BADGE
           ======================================== */
        .privacy-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(16, 126, 62, 0.1);
            color: var(--sapPositiveColor);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .privacy-badge svg {
            width: 16px;
            height: 16px;
        }

        /* ========================================
           UPLOAD CARD
           ======================================== */
        .upload-card {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .upload-zone {
            border: 2px dashed #89919A;
            border-radius: 8px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--sapBrandColor);
            background: rgba(0, 112, 242, 0.02);
        }

        .upload-zone input {
            display: none;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: var(--sapContent_LabelColor);
        }

        .upload-text {
            font-size: 1rem;
            color: var(--sapTextColor);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.875rem;
            color: var(--sapContent_LabelColor);
        }

        /* ========================================
           CARDS & TILES
           ======================================== */
        .fiori-card {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .section-header {
            font-size: 1rem;
            font-weight: 600;
            color: var(--sapTitleColor);
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #E5E5E5;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
        }

        .fiori-info-tile {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            padding: 1rem 1.25rem;
        }

        .fiori-info-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--sapContent_LabelColor);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .fiori-info-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--sapTextColor);
            word-break: break-word;
        }

        /* ========================================
           NUMERIC TILES
           ======================================== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .fiori-numeric-tile {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            padding: 1.25rem;
            text-align: center;
        }

        .fiori-numeric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--sapBrandColor);
            line-height: 1.1;
        }

        .fiori-numeric-label {
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--sapContent_LabelColor);
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        /* ========================================
           STATUS BADGES
           ======================================== */
        .fiori-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .fiori-status-info {
            background-color: rgba(0, 112, 242, 0.12);
            color: var(--sapInformationColor);
        }

        .fiori-status-success {
            background-color: rgba(16, 126, 62, 0.12);
            color: var(--sapPositiveColor);
        }

        .fiori-status-warning {
            background-color: rgba(233, 115, 12, 0.12);
            color: var(--sapCriticalColor);
        }

        /* ========================================
           CONTACT CHIPS
           ======================================== */
        .fiori-contact-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .fiori-contact-chip {
            display: inline-flex;
            align-items: center;
            background: #F0F1F2;
            border-radius: 16px;
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
            color: var(--sapTextColor);
        }

        /* ========================================
           COPYABLE FIELDS
           ======================================== */
        .copyable-field {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .copy-btn-small {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: transparent;
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .copy-btn-small:hover {
            background: #F0F1F2;
            border-color: var(--sapBrandColor);
        }

        .copy-btn-small svg {
            width: 14px;
            height: 14px;
            color: var(--sapContent_LabelColor);
        }

        .copy-btn-small:hover svg {
            color: var(--sapBrandColor);
        }

        .copy-btn-small.copied {
            background: rgba(16, 126, 62, 0.1);
            border-color: var(--sapPositiveColor);
        }

        .copy-btn-small.copied svg {
            color: var(--sapPositiveColor);
        }

        .contacts-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .contacts-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--sapContent_LabelColor);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ========================================
           CODE BLOCK
           ======================================== */
        .code-card {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            overflow: hidden;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #F5F6F7;
            border-bottom: 1px solid #E5E5E5;
        }

        .code-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--sapTitleColor);
        }

        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.5rem 1rem;
            background: var(--sapButton_Background);
            color: var(--sapButton_TextColor);
            border: none;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .copy-btn:hover {
            background: var(--sapButton_Hover_Background);
        }

        .copy-btn.copied {
            background: var(--sapPositiveColor);
        }

        .copy-btn svg {
            width: 14px;
            height: 14px;
        }

        .outlook-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #0078D4 0%, #106EBE 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 120, 212, 0.3);
            margin-top: 1rem;
        }

        .outlook-btn:hover {
            background: linear-gradient(135deg, #106EBE 0%, #005A9E 100%);
            box-shadow: 0 4px 8px rgba(0, 120, 212, 0.4);
            transform: translateY(-1px);
        }

        .outlook-btn:active {
            transform: translateY(0);
        }

        .outlook-btn svg {
            width: 18px;
            height: 18px;
        }

        /* ========================================
           INPUT FIELDS
           ======================================== */
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .input-row {
                grid-template-columns: 1fr;
            }
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-label {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--sapTitleColor);
        }

        .input-field {
            padding: 0.625rem 0.875rem;
            border: 1px solid #89919A;
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--sapTextColor);
            background: var(--sapSurfaceColor);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--sapBrandColor);
            box-shadow: 0 0 0 3px rgba(0, 112, 242, 0.15);
        }

        .input-field::placeholder {
            color: var(--sapContent_LabelColor);
        }

        .code-body {
            padding: 1rem;
            background: #FAFBFC;
            font-family: "Consolas", "Monaco", "Courier New", monospace;
            font-size: 0.8125rem;
            color: var(--sapTextColor);
            line-height: 1.6;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        /* ========================================
           DATA TABLE
           ======================================== */
        .data-table-wrapper {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            overflow: hidden;
        }

        .data-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #F5F6F7;
            border-bottom: 1px solid #E5E5E5;
            cursor: pointer;
        }

        .data-table-header:hover {
            background: #EDEFF0;
        }

        .data-table-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--sapTitleColor);
        }

        .data-table-content {
            display: none;
            overflow-x: auto;
        }

        .data-table-content.expanded {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        .data-table th {
            background: #F5F6F7;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--sapTitleColor);
            border-bottom: 1px solid #E5E5E5;
            white-space: nowrap;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #E5E5E5;
            color: var(--sapTextColor);
        }

        .data-table tr:hover {
            background: #F5F6F7;
        }

        /* ========================================
           EMPTY STATE
           ======================================== */
        .empty-state {
            background: var(--sapSurfaceColor);
            border-radius: var(--sapTile_BorderRadius);
            box-shadow: var(--sapTile_BoxShadow);
            padding: 4rem 2rem;
            text-align: center;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #E8F4FD 0%, #D6E9FA 100%);
            border-radius: 50%;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-icon svg {
            width: 28px;
            height: 28px;
            color: var(--sapBrandColor);
        }

        .empty-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--sapTitleColor);
            margin-bottom: 0.5rem;
        }

        .empty-text {
            font-size: 0.875rem;
            color: var(--sapContent_LabelColor);
        }

        /* ========================================
           FOOTER
           ======================================== */
        .fiori-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            padding: 0.75rem 1rem;
            background: var(--sapBackgroundColor);
            color: var(--sapContent_LabelColor);
            font-size: 0.8125rem;
            border-top: 1px solid #E5E5E5;
            z-index: 100;
        }

        /* ========================================
           HIDDEN
           ======================================== */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Shell Bar -->
    <header class="fiori-shell">
        <div class="shell-logo">
            <img src="saplogo.png" alt="SAP" class="sap-logo">
        </div>
        <span class="shell-title">POM Assistant 2.0</span>
        <div class="shell-user">
            <div class="shell-avatar">PS</div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="fiori-content">
        <!-- Page Header -->
        <div class="fiori-page-header">
            <h1 class="fiori-page-title">AQL Query Generator</h1>
            <p class="fiori-page-subtitle">Generate AQL queries from SAP Ariba monitoring reports</p>
        </div>

        <!-- Privacy Badge -->
        <div class="privacy-badge">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                <path d="M9 12l2 2 4-4"/>
            </svg>
            100% Private - Data never leaves your browser
        </div>

        <!-- Upload Card -->
        <div class="upload-card">
            <!-- Case Number and ITSM REF Inputs -->
            <div class="input-row">
                <div class="input-group">
                    <label class="input-label" for="caseNumberInput">Case Number</label>
                    <input type="text" id="caseNumberInput" class="input-field" placeholder="e.g., CS20250011256983" oninput="updateEmailPreview()">
                </div>
                <div class="input-group">
                    <label class="input-label" for="itsmRefInput">ITSM Reference</label>
                    <input type="text" id="itsmRefInput" class="input-field" placeholder="e.g., Ref:MSG947716891_yyaB2oN7NHK0O7KVgl" oninput="updateEmailPreview()">
                </div>
            </div>
            
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="fileInput" accept=".xlsx,.xls">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="12" y1="18" x2="12" y2="12"/>
                    <polyline points="9 15 12 12 15 15"/>
                </svg>
                <p class="upload-text">Click to upload or drag and drop</p>
                <p class="upload-hint">Supports PO_Ordering, RC_Processing, CLID_Request_Error, PAY_Sending, CR_Sourcing_Confirming, Stuck_Process_Flow_Projects, Req_Approved_No_PO, Appr_Sbmtd_No_ActAppr, and OK2Pay_Empty_Export Excel files</p>
            </div>
        </div>

        <!-- Results Container (hidden by default) -->
        <div id="resultsContainer" class="hidden">
            <!-- Status Badge -->
            <div id="statusBadge"></div>

            <!-- Report Information -->
            <h2 class="section-header">Report Information</h2>
            <div class="info-grid" id="infoGrid"></div>

            <!-- Customer Contacts -->
            <div id="contactsSection" class="hidden">
                <h2 class="section-header">Customer Contacts</h2>
                <div class="fiori-card">
                    <div class="contacts-header">
                        <span class="contacts-label">Email Addresses</span>
                        <button class="copy-btn-small" id="copyContactsBtn" onclick="copyContacts()" title="Copy all contacts">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                    <div class="fiori-contact-list" id="contactsList"></div>
                </div>
            </div>

            <!-- Summary -->
            <h2 class="section-header">Summary</h2>
            <div class="metrics-grid" id="metricsGrid"></div>

            <!-- Query Section -->
            <div id="querySection" class="hidden">
                <h2 class="section-header">Generated AQL Query</h2>
                <div class="code-card">
                    <div class="code-header">
                        <span class="code-title">AQL Query</span>
                        <button class="copy-btn" id="copyBtn" onclick="copyQuery()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                            Copy
                        </button>
                    </div>
                    <pre class="code-body" id="queryCode"></pre>
                </div>
            </div>

            <!-- Email Template Section -->
            <div id="emailSection">
                <h2 class="section-header">Email Template</h2>
                
                <!-- Subject -->
                <div class="fiori-info-tile" style="margin-bottom: 1rem;">
                    <div class="fiori-info-label">Subject</div>
                    <div class="copyable-field">
                        <span class="fiori-info-value" id="emailSubject"></span>
                        <button class="copy-btn-small" id="copySubjectBtn" onclick="copySubject()" title="Copy subject">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Body -->
                <div class="code-card">
                    <div class="code-header">
                        <span class="code-title">Body</span>
                        <button class="copy-btn" id="copyEmailBtn" onclick="copyEmailBody()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                            Copy
                        </button>
                    </div>
                    <pre class="code-body" id="emailBody"></pre>
                </div>
                
                <!-- Open in Outlook Button -->
                <button class="outlook-btn" id="openOutlookBtn" onclick="openInOutlook()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Open in Outlook
                </button>
            </div>

            <!-- Raw Data -->
            <h2 class="section-header">Raw Data</h2>
            <div class="data-table-wrapper">
                <div class="data-table-header" onclick="toggleDataTable()">
                    <span class="data-table-title">View uploaded data</span>
                    <svg id="expandIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="data-table-content" id="dataTableContent">
                    <table class="data-table" id="dataTable"></table>
                </div>
            </div>
        </div>

        <!-- Empty State (shown by default) -->
        <div id="emptyState" class="empty-state">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="12" y1="18" x2="12" y2="12"/>
                    <polyline points="9 15 12 12 15 15"/>
                </svg>
            </div>
            <h2 class="empty-title">Upload Monitoring File</h2>
            <p class="empty-text">Drag and drop an Excel file or click to browse.<br>Supports PO_Ordering, RC_Processing, CLID_Request_Error, PAY_Sending, CR_Sourcing_Confirming, Stuck_Process_Flow_Projects, Req_Approved_No_PO, Appr_Sbmtd_No_ActAppr, and OK2Pay_Empty_Export reports.</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="fiori-footer">
        Created by Michal Gulas
    </footer>

    <script>
        // Global variables
        let currentQuery = '';
        let currentData = null;
        let currentContacts = '';
        let currentProductSpecialist = '';
        let currentEmailSubject = '';
        let currentEmailBody = '';
        let currentMonitoringType = '';
        let currentCustomerName = '';
        let hasCustomerContacts = false;
        let currentCaseNumber = '';
        let currentItsmRef = '';
        let currentRealm = '';
        let currentRecordCount = 0;
        let currentUniqueNames = [];

        // File upload handling
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });

        // Process Excel file
        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Detect monitoring type
                    const sheetNames = workbook.SheetNames;
                    let monitoringType = null;
                    let infoData = null;
                    let mainData = null;

                    if (sheetNames.includes('Info')) {
                        infoData = XLSX.utils.sheet_to_json(workbook.Sheets['Info'], { header: 1 });
                    }

                    if (sheetNames.includes('PO_Ordering')) {
                        mainData = XLSX.utils.sheet_to_json(workbook.Sheets['PO_Ordering']);
                        monitoringType = 'PO_Ordering';
                    } else if (sheetNames.includes('RC_Processing')) {
                        mainData = XLSX.utils.sheet_to_json(workbook.Sheets['RC_Processing']);
                        monitoringType = 'RC_Processing';
                    } else if (sheetNames.includes('CLID_Request_Error')) {
                        mainData = XLSX.utils.sheet_to_json(workbook.Sheets['CLID_Request_Error']);
                        monitoringType = 'CLID_Request_Error';
                    } else if (sheetNames.includes('PAY_Sending')) {
                        mainData = XLSX.utils.sheet_to_json(workbook.Sheets['PAY_Sending']);
                        monitoringType = 'PAY_Sending';
                    } else if (sheetNames.includes('CR_Sourcing_Confirming')) {
                        mainData = XLSX.utils.sheet_to_json(workbook.Sheets['CR_Sourcing_Confirming']);
                        monitoringType = 'CR_Sourcing_Confirming';
                    } else if (sheetNames.includes('Stuck_Process_Flow_Projects')) {
                        mainData = XLSX.utils.sheet_to_json(workbook.Sheets['Stuck_Process_Flow_Projects']);
                        monitoringType = 'Stuck_Process_Flow_Projects';
                    } else if (sheetNames.includes('Req_Approved_No_PO')) {
                        mainData = XLSX.utils.sheet_to_json(workbook.Sheets['Req_Approved_No_PO']);
                        monitoringType = 'Req_Approved_No_PO';
                    } else if (sheetNames.includes('Appr_Sbmtd_No_ActAppr')) {
                        mainData = XLSX.utils.sheet_to_json(workbook.Sheets['Appr_Sbmtd_No_ActAppr']);
                        monitoringType = 'Appr_Sbmtd_No_ActAppr';
                    } else if (sheetNames.includes('OK2Pay_Empty_Export')) {
                        mainData = XLSX.utils.sheet_to_json(workbook.Sheets['OK2Pay_Empty_Export']);
                        monitoringType = 'OK2Pay_Empty_Export';
                    } else {
                        // Find first non-Info sheet
                        for (const sheet of sheetNames) {
                            if (sheet !== 'Info') {
                                mainData = XLSX.utils.sheet_to_json(workbook.Sheets[sheet]);
                                monitoringType = sheet;
                                break;
                            }
                        }
                    }

                    if (!monitoringType || !mainData) {
                        alert('Could not detect monitoring type. Please ensure the file contains valid data.');
                        return;
                    }

                    currentData = mainData;
                    displayResults(monitoringType, infoData, mainData);

                } catch (error) {
                    alert('Error processing file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Extract info from Info sheet
        function extractInfo(infoData) {
            const info = {};
            if (!infoData) return info;

            for (const row of infoData) {
                if (row.length >= 2) {
                    const key = String(row[0] || '').trim();
                    const value = String(row[1] || '').trim();
                    
                    if (key === 'Realm') info.realm = value;
                    else if (key === 'PSEE Consultant') info.productSpecialist = value;
                    else if (key === 'Monitoring Contacts') info.customerContacts = value;
                    else if (key === 'Data Center') info.dataCenter = value;
                    else if (key === 'Customer Account Name') info.customerName = value;
                }
            }
            return info;
        }

        // Display results
        function displayResults(monitoringType, infoData, mainData) {
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsContainer').classList.remove('hidden');

            const info = extractInfo(infoData);

            // Status badge
            const statusBadge = document.getElementById('statusBadge');
            if (monitoringType === 'PO_Ordering') {
                statusBadge.innerHTML = '<span class="fiori-status fiori-status-info">PO Ordering</span>';
            } else if (monitoringType === 'RC_Processing') {
                statusBadge.innerHTML = '<span class="fiori-status fiori-status-success">RC Processing</span>';
            } else if (monitoringType === 'CLID_Request_Error') {
                statusBadge.innerHTML = '<span class="fiori-status fiori-status-warning">CLID Request Error</span>';
            } else if (monitoringType === 'PAY_Sending') {
                statusBadge.innerHTML = '<span class="fiori-status fiori-status-warning">PAY Sending</span>';
            } else if (monitoringType === 'CR_Sourcing_Confirming') {
                statusBadge.innerHTML = '<span class="fiori-status fiori-status-warning">CR Sourcing Confirming</span>';
            } else if (monitoringType === 'Stuck_Process_Flow_Projects') {
                statusBadge.innerHTML = '<span class="fiori-status fiori-status-warning">Stuck Process Flow Projects</span>';
            } else if (monitoringType === 'Req_Approved_No_PO') {
                statusBadge.innerHTML = '<span class="fiori-status fiori-status-warning">Req Approved No PO</span>';
            } else if (monitoringType === 'Appr_Sbmtd_No_ActAppr') {
                statusBadge.innerHTML = '<span class="fiori-status fiori-status-warning">Appr Sbmtd No ActAppr</span>';
            } else if (monitoringType === 'OK2Pay_Empty_Export') {
                statusBadge.innerHTML = '<span class="fiori-status fiori-status-warning">OK2Pay Empty Export</span>';
            } else {
                statusBadge.innerHTML = `<span class="fiori-status fiori-status-warning">${monitoringType.replace('_', ' ')}</span>`;
            }

            // Store monitoring type, customer name, and realm for email
            currentMonitoringType = monitoringType;
            currentCustomerName = info.customerName || 'Customer Account Name';
            currentRealm = info.realm || '';

            // Store product specialist for copy
            currentProductSpecialist = info.productSpecialist || '';
            
            // Get case number and ITSM ref from inputs
            currentCaseNumber = document.getElementById('caseNumberInput').value.trim();
            currentItsmRef = document.getElementById('itsmRefInput').value.trim();

            // Info grid
            const infoGrid = document.getElementById('infoGrid');
            const psValue = info.productSpecialist || 'N/A';
            const psCopyBtn = info.productSpecialist ? `
                <button class="copy-btn-small" id="copyPsBtn" onclick="copyProductSpecialist()" title="Copy email">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                </button>
            ` : '';
            
            infoGrid.innerHTML = `
                <div class="fiori-info-tile">
                    <div class="fiori-info-label">Realm</div>
                    <div class="fiori-info-value">${info.realm || 'N/A'}</div>
                </div>
                <div class="fiori-info-tile">
                    <div class="fiori-info-label">Product Specialist</div>
                    <div class="copyable-field">
                        <span class="fiori-info-value">${psValue}</span>
                        ${psCopyBtn}
                    </div>
                </div>
                <div class="fiori-info-tile">
                    <div class="fiori-info-label">Data Center</div>
                    <div class="fiori-info-value">${info.dataCenter || 'N/A'}</div>
                </div>
            `;

            // Customer contacts
            const contactsSection = document.getElementById('contactsSection');
            const contactsList = document.getElementById('contactsList');
            hasCustomerContacts = !!info.customerContacts;
            if (info.customerContacts) {
                contactsSection.classList.remove('hidden');
                const contacts = info.customerContacts.split(',').map(c => c.trim());
                currentContacts = contacts.join(', ');
                contactsList.innerHTML = contacts.map(c => `<span class="fiori-contact-chip">${c}</span>`).join('');
            } else {
                contactsSection.classList.add('hidden');
                currentContacts = '';
            }

            // Get unique names (or InternalIds for Stuck_Process_Flow_Projects)
            let uniqueNames;
            if (monitoringType === 'Stuck_Process_Flow_Projects') {
                uniqueNames = [...new Set(mainData.map(row => row.InternalId).filter(Boolean))];
            } else {
                uniqueNames = [...new Set(mainData.map(row => row.UniqueName).filter(Boolean))];
            }
            const recordCount = uniqueNames.length || mainData.length;
            
            // Store for email preview updates
            currentRecordCount = recordCount;
            currentUniqueNames = uniqueNames;

            // Metrics
            const metricsGrid = document.getElementById('metricsGrid');
            const typeLabel = monitoringType === 'PO_Ordering' ? 'PO' : 
                             monitoringType === 'RC_Processing' ? 'RC' : 
                             monitoringType === 'CLID_Request_Error' ? 'CLID' :
                             monitoringType === 'PAY_Sending' ? 'PAY' :
                             monitoringType === 'CR_Sourcing_Confirming' ? 'CR' :
                             monitoringType === 'Stuck_Process_Flow_Projects' ? 'PFP' :
                             monitoringType === 'Req_Approved_No_PO' ? 'PR' :
                             monitoringType === 'Appr_Sbmtd_No_ActAppr' ? 'APPR' :
                             monitoringType === 'OK2Pay_Empty_Export' ? 'OK2P' :
                             monitoringType.substring(0, 3).toUpperCase();
            metricsGrid.innerHTML = `
                <div class="fiori-numeric-tile">
                    <div class="fiori-numeric-value">${recordCount}</div>
                    <div class="fiori-numeric-label">Total Records</div>
                </div>
                <div class="fiori-numeric-tile">
                    <div class="fiori-numeric-value">${typeLabel}</div>
                    <div class="fiori-numeric-label">Record Type</div>
                </div>
            `;

            // Query section
            const querySection = document.getElementById('querySection');
            const queryCode = document.getElementById('queryCode');
            
            if (monitoringType === 'PO_Ordering' || monitoringType === 'RC_Processing' || 
                monitoringType === 'CR_Sourcing_Confirming' || monitoringType === 'Stuck_Process_Flow_Projects' ||
                monitoringType === 'OK2Pay_Empty_Export') {
                querySection.classList.remove('hidden');
                currentQuery = generateQuery(monitoringType, uniqueNames, mainData);
                queryCode.textContent = currentQuery;
            } else {
                querySection.classList.add('hidden');
            }

            // Email template section
            const emailSubject = document.getElementById('emailSubject');
            const emailBody = document.getElementById('emailBody');
            const emailTemplate = generateEmailTemplate(monitoringType, currentCustomerName, info.productSpecialist, hasCustomerContacts, recordCount, uniqueNames);
            currentEmailSubject = emailTemplate.subject;
            currentEmailBody = emailTemplate.body;
            emailSubject.textContent = currentEmailSubject;
            emailBody.textContent = currentEmailBody;

            // Data table
            renderDataTable(mainData);
        }

        // Extract first name from email address
        function getFirstNameFromEmail(email) {
            if (!email) return 'Product Specialist';
            // Extract the part before @ and get the first name (before the dot)
            const localPart = email.split('@')[0];
            const firstName = localPart.split('.')[0];
            // Capitalize first letter
            return firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
        }

        // Generate email template based on type
        function generateEmailTemplate(type, customerName, productSpecialistEmail, hasCustomerContacts, recordCount = 0, uniqueNames = []) {
            const firstName = getFirstNameFromEmail(productSpecialistEmail);
            const greeting = hasCustomerContacts ? 'Hello Team,' : `Hello ${firstName},`;
            const isSingleRecord = recordCount === 1;
            const singleUniqueName = uniqueNames.length === 1 ? uniqueNames[0] : '';
            
            switch(type) {
                case 'PO_Ordering':
                    return generatePOEmail(customerName, greeting, hasCustomerContacts);
                case 'RC_Processing':
                    return generateRCEmail(customerName, greeting, hasCustomerContacts);
                case 'CLID_Request_Error':
                    return generateCLIDEmail(customerName, firstName, hasCustomerContacts);
                case 'PAY_Sending':
                    return generatePAYEmail(customerName, firstName);
                case 'CR_Sourcing_Confirming':
                    return generateCRSourcingConfirmingEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                case 'Stuck_Process_Flow_Projects':
                    return generateStuckProcessFlowProjectsEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                case 'Req_Approved_No_PO':
                    return generateReqApprovedNoPOEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                case 'Appr_Sbmtd_No_ActAppr':
                    return generateApprSbmtdNoActApprEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                case 'OK2Pay_Empty_Export':
                    return generateOK2PayEmptyExportEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, singleUniqueName);
                default:
                    return {
                        subject: formatSubject(`Proactive Monitoring - ${type.replace(/_/g, ' ')}`, customerName),
                        body: formatBody(`${greeting}\n\nPlease review the attached monitoring data.`)
                    };
            }
        }

        // Format subject with case number and realm
        function formatSubject(basePart, customerName) {
            const realmPart = currentRealm ? `, realm ${currentRealm}` : '';
            const subjectBase = `PSEE Proactive Monitoring - customer ${customerName}${realmPart} - ${basePart}`;
            return currentCaseNumber ? `${currentCaseNumber} ${subjectBase}` : subjectBase;
        }

        // Format body with ITSM reference
        function formatBody(baseBody) {
            return currentItsmRef ? `${baseBody}\n\n${currentItsmRef}` : baseBody;
        }

        function generatePOEmail(customerName, greeting, hasCustomerContacts) {
            const closing = hasCustomerContacts 
                ? 'If you need further assistance, you are welcome to submit a new support case with SAP Ariba.'
                : 'Please forward this information to the customer. If they need further assistance, they are welcome to submit a new support case with SAP Ariba.';
            
            const bodyContent = `${greeting}

Our Proactive Monitoring queries identified several Ariba purchase orders with status = Ordering.
The cause of this status is:
• lack of response from the ERP side. Please check the status of these POs in your ERP.
• missing trading relationship with supplier in SAP Business Network

${closing}`;
            
            return {
                subject: formatSubject('POs in status = Ordering', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateRCEmail(customerName, greeting, hasCustomerContacts) {
            const closing = hasCustomerContacts 
                ? 'If you need further assistance, you are welcome to submit a new support case with SAP Ariba.'
                : 'Please forward this information to the customer. If they need further assistance, they are welcome to submit a new support case with SAP Ariba.';
            
            const bodyContent = `${greeting}

Our Proactive Monitoring queries identified several Ariba receipts with Processing State = Processing.
These receipts were approved in Ariba and send to the ERP system.

The ERP system rejected the receipts with due to various errors. The errors may be viewed in the Comments section when accessing individual receipts in SAP Ariba Buying & Invoicing.
The list of affected RCs is in the attached Excel file.

Ariba retries 4 times a day to re-send the receipts to ERP until they are successfully processed or the max number of retries is used.
The maximum number of retries is determined by parameter Application.Receiving.MaxRetriesToSendPushFailedReceipts set in your realm.

${closing}`;
            
            return {
                subject: formatSubject('RCs in Processing Status = Processing', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateCLIDEmail(customerName, firstName, hasCustomerContacts) {
            if (hasCustomerContacts) {
                // Email template for when customer contacts are available
                const bodyContent = `Hello Team,

Our proactive monitoring queries identified several Contract Workspaces with a CLID request error.
The list of the affected CWs is in the attached Excel file.

How to review the affected CW: Search > Contract Workspace (Procurement) > search by CW ID

Usual CLID request error types:

ReceivedContractStatusUpdateRequestFailure
ReceivedContractStatusUpdateRequestFailure error indicates that the CSUR was successfully processed without any issue, but 500 (failure) response is returned by ERP meaning the corresponding Contract document was NOT created on ERP side. Reviewing the details (in History), we can see the error is caused by Master data, which means that fix requires client engagement.

SendContractRequestFailureWithContractID
Link: https://support.ariba.com/item/view/KB0409688

ProcessContractStatusUpdateRequestInternalError
Link: https://support.ariba.com/item/view/KB0402285
Missing Document Type attribute when sending a CLID to an external system

This issue is caused by ERP Errors received from your ERP system. You should be able to resolve the issue by adjusting the content of the affected CW with the corresponding object in your ERP.`;
                
                return {
                    subject: formatSubject('CLID Request Error', customerName),
                    body: formatBody(bodyContent)
                };
            } else {
                // Email template for when no customer contacts (send to Product Specialist)
                const bodyContent = `Hello ${firstName},

Our proactive monitoring queries identified several Contract Workspaces with a CLID request error.
The list of the affected CWs is in the attached Excel file.

How to review the affected CW: Search > Contract Workspace (Procurement) > search by CW ID

Usual CLID request error types:

ReceivedContractStatusUpdateRequestFailure
ReceivedContractStatusUpdateRequestFailure error indicates that the CSUR was successfully processed without any issue, but 500 (failure) response is returned by ERP meaning the corresponding Contract document was NOT created on ERP side. Reviewing the details (in History), we can see the error is caused by Master data, which means that fix requires client engagement.

SendContractRequestFailureWithContractID
Link: https://support.ariba.com/item/view/KB0409688

ProcessContractStatusUpdateRequestInternalError
Link: https://support.ariba.com/item/view/KB0402285
Missing Document Type attribute when sending a CLID to an external system

This issue is caused by ERP Errors received from the customer's ERP system. To resolve the issue, we need to notify the customer to check and make necessary corrections. Please notify the customer about the issue. In general, the customer should be able to resolve the issue by adjusting the content of the affected CW with the corresponding object in their ERP.

If you want me to email similar notifications directly to the customer (with you in CC), please update the customer contact for proactive monitoring in PSEE Operational Dashboard.`;
                
                return {
                    subject: formatSubject('CLID Request Error', customerName),
                    body: formatBody(bodyContent)
                };
            }
        }

        function generatePAYEmail(customerName, firstName) {
            const bodyContent = `Hello ${firstName},

Our proactive monitoring queries identified multiple Payments in status Sending. The status is caused by ERP errors & AN errors hence the troubleshooting should be on one-by-one basis.

The list of affected payments is in the attached Excel file.

Please forward the list to the customer.
If they need additional assistance from our side, please have them submit a support case with SAP Ariba.`;
            
            return {
                subject: formatSubject('Payments in status Sending', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateCRSourcingConfirmingEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email for contacts with one CR
                    bodyContent = `Hello Team,

Our proactive monitoring has identified that contract request ${uniqueName} is currently stuck in status Sourcing Confirming.

This issue can occur for various reasons and may require further investigation, including the potential use of the Repair Integration tool.

Please open a new support case with us referencing this contract request ID and its current status. 
Our team will be happy to assist you in resolving the matter promptly.`;
                } else {
                    // Email for contacts with more CRs
                    bodyContent = `Hello Team,

Our proactive monitoring has identified that several CRs are currently stuck in status Sourcing Confirming. The list of the affected CRs is in the attached excel file. 

This issue can occur for various reasons and may require further investigation, including the potential use of the Repair Integration tool.

Please open a new support case with us referencing this contract request ID and its current status. 
Our team will be happy to assist you in resolving the matter promptly.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email for product specialist with one CR
                    bodyContent = `Hello ${firstName},

Our proactive monitoring has identified that contract request ${uniqueName} is currently stuck in status Sourcing Confirming.

This issue can occur for various reasons and may require further investigation, including the potential use of the Repair Integration tool.

Please notify the customer about the occurrence. They are advised to open a new support case with us referencing this contract request ID and its current status. 
Our team will be happy to assist them in resolving the matter promptly.`;
                } else {
                    // Email for product specialist with several CRs
                    bodyContent = `Hello ${firstName},

Our proactive monitoring has identified that several CRs are currently stuck in status Sourcing Confirming. The list of the affected CRs is in the attached excel file. 

This issue can occur for various reasons and may require further investigation, including the potential use of the Repair Integration tool.

Please notify the customer about the occurrence. They are advised to open a new support case with us referencing this contract request ID and its current status. 
Our team will be happy to assist them in resolving the matter promptly.`;
                }
            }
            
            return {
                subject: formatSubject('CR in status Sourcing Confirming', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateStuckProcessFlowProjectsEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email to customer contacts one record
                    bodyContent = `Hello Team,

Our proactive monitoring queries identified SM Process Project ${uniqueName} in status In Process.
All associated questionnaires and tasks are in a compliant state, hence the above WS status seems not to be compliant.

If you need additional assistance, you are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to customer contacts more records
                    bodyContent = `Hello Team,

Our proactive monitoring queries identified several SM Process Projects in status In Process. You can find the affected Projects in the attached excel file.
All associated questionnaires and tasks are in a compliant state, hence the above WS status seems not to be compliant.

If you need additional assistance, you are welcome to submit a support case with SAP Ariba.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email to product specialist one record
                    bodyContent = `Hello ${firstName},

Our proactive monitoring queries identified SM Process Project ${uniqueName} in status In Process.
All associated questionnaires and tasks are in a compliant state, hence the above WS status seems not to be compliant.

Please notify the customer about this occurrence.
If they need additional assistance, they are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to product specialist more records
                    bodyContent = `Hello ${firstName},

Our proactive monitoring queries identified several SM Process Projects in status In Process. You can find the affected Projects in the attached excel file.
All associated questionnaires and tasks are in a compliant state, hence the above WS status seems not to be compliant.

Please notify the customer about this occurrence.
If they need additional assistance, they are welcome to submit a support case with SAP Ariba.`;
                }
            }
            
            return {
                subject: formatSubject('SM Process Projects in status In Process', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateReqApprovedNoPOEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email to customer contacts with one PR
                    bodyContent = `Hello Team,

our proactive monitoring queries identified ${uniqueName} in status Approved.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to customer contacts with more PRs
                    bodyContent = `Hello Team,

our proactive monitoring queries identified several PRs in status Approved.

You can find the list of the PRs in the attached Excel file.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email to PS with one PR
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified ${uniqueName} in status Approved.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to PS with more PRs
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified several PRs in status Approved.

You can find the list of the PRs in the attached Excel file.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                }
            }
            
            return {
                subject: formatSubject('Requisition in status Approved with no PO', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateApprSbmtdNoActApprEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email to customer contacts with one Approvable
                    bodyContent = `Hello Team,

our proactive monitoring queries identified ${uniqueName} in status Submitted without any active approvers in the Approval Flow.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to customer contacts with more Approvables
                    bodyContent = `Hello Team,

our proactive monitoring queries identified several Approvable Objects in status Submitted without any active approvers in the Approval Flow.

You can find the list of the Approvables in the attached Excel file.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email to PS with one Approvable
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified ${uniqueName} in status Submitted without any active approvers in the Approval Flow.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to PS with more Approvables
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified several Approvable Objects in status Submitted without any active approvers in the Approval Flow.

You can find the list of the Approvables in the attached Excel file.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                }
            }
            
            return {
                subject: formatSubject('Approvable object in status Submitted with no active', customerName),
                body: formatBody(bodyContent)
            };
        }

        function generateOK2PayEmptyExportEmail(customerName, firstName, hasCustomerContacts, isSingleRecord, uniqueName) {
            let bodyContent;
            
            if (hasCustomerContacts) {
                if (isSingleRecord) {
                    // Email to customer contacts with one record
                    bodyContent = `Hello Team,

our proactive monitoring queries identified OK2Pay export ${uniqueName} with 0 records exported.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to customer contacts with more records
                    bodyContent = `Hello Team,

our proactive monitoring queries identified several OK2Pay exports with 0 records exported.

You can find the list of the affected exports in the attached Excel file.

<Insert your investigation of the issue here>

If you need additional assistance with the above occurrences, you are welcome to submit a support case with SAP Ariba.`;
                }
            } else {
                if (isSingleRecord) {
                    // Email to PS with one record
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified OK2Pay export ${uniqueName} with 0 records exported.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                } else {
                    // Email to PS with more records
                    bodyContent = `Hello ${firstName},

our proactive monitoring queries identified several OK2Pay exports with 0 records exported.

You can find the list of the affected exports in the attached Excel file.

<Insert your investigation of the issue here>

Please notify the customer about the occurrence. If they need additional assistance with the above occurrences, they are welcome to submit a support case with SAP Ariba.`;
                }
            }
            
            return {
                subject: formatSubject('OK2Pay Empty Export', customerName),
                body: formatBody(bodyContent)
            };
        }

        // Update email preview when case number or ITSM ref changes
        function updateEmailPreview() {
            // Only update if results are displayed
            if (document.getElementById('resultsContainer').classList.contains('hidden')) {
                return;
            }
            
            // Get current input values
            currentCaseNumber = document.getElementById('caseNumberInput').value.trim();
            currentItsmRef = document.getElementById('itsmRefInput').value.trim();
            
            // Regenerate email template
            const emailTemplate = generateEmailTemplate(currentMonitoringType, currentCustomerName, currentProductSpecialist, hasCustomerContacts, currentRecordCount, currentUniqueNames);
            currentEmailSubject = emailTemplate.subject;
            currentEmailBody = emailTemplate.body;
            
            // Update display
            document.getElementById('emailSubject').textContent = currentEmailSubject;
            document.getElementById('emailBody').textContent = currentEmailBody;
        }

        // Generate AQL query
        function generateQuery(type, uniqueNames, mainData = []) {
            const namesStr = uniqueNames.map(n => `'${n}'`).join(', ');
            
            if (type === 'PO_Ordering') {
                return `SELECT
UniqueName "PO ID Ariba",
OrderID "Order ID SAP",
Name "PO Title",
StatusString "Status",
"Active" "Active",
TimeCreated,
TimeUpdated,
Recipients.OrderingMethod "Ordering Method",
Recipients.State "Recipient State",
Recipients.FailureReason "Failure Reason",
Recipients.TimeCreated "Recipient TimeCreated",
Recipients.TimeUpdated "Recipient TimeUpdated",
Supplier.Name as "Supplier Name",
Supplier.UniqueName as "Supplier ID",
SupplierLocation.PreferredOrderingMethod as SupplierOrderingMethod,
SupplierLocation.EmailAddress as EmailAddress,
SupplierLocation.AribaNetworkId as AribaNetworkId,
this
FROM ariba.purchasing.core.PurchaseOrder
WHERE UniqueName IN (${namesStr})
ORDER BY StatusString, UniqueName, TimeCreated, Recipients.OrderingMethod`;
            } else if (type === 'RC_Processing') {
                return `SELECT DISTINCT UniqueName as "Id",
UniqueName,
StatusString,
CreateDate,
ApprovedDate,
'Awaiting processing' ProcessedStateString
FROM ariba.receiving.core.Receipt
WHERE StatusString = 'Approved'
AND ProcessedState = 1
AND UniqueName IN (${namesStr})
ORDER BY ApprovedDate DESC`;
            } else if (type === 'CR_Sourcing_Confirming') {
                return `SELECT
UniqueName,
StatusString,
TimeCreated,
TimeUpdated,
"Active" "Active",
this
FROM ContractRequest INCLUDE INACTIVE
WHERE UniqueName IN (${namesStr})
ORDER BY TimeCreated`;
            } else if (type === 'Stuck_Process_Flow_Projects') {
                // For Stuck_Process_Flow_Projects, we use InternalId instead of UniqueName
                const internalIds = [...new Set(mainData.map(row => row.InternalId).filter(Boolean))];
                const idsStr = internalIds.map(n => `'${n}'`).join(', ');
                return `SELECT DISTINCT
InternalId AS "Id",
InternalId,
Title,
ProcessFlowStatus,
ProjectAddin.Plan.EndDateTime AS "Plan End Date",
ProjectAddin.Plan.Status AS "Plan Status"
FROM ariba.sourcing.content.SMProcessFlowProject
WHERE ProcessFlowStatus NOT IN ('ConditionallyApproved','PendingDecision','Approved','Denied','Cancelled')
AND InternalId IN (${idsStr})
ORDER BY InternalId`;
            } else if (type === 'OK2Pay_Empty_Export') {
                return `SELECT UniqueName AS "Id",
UniqueName,
StartRunDate,
EndRunDate,
AdapterName,
CurrentTime() AS "QueryDate"
FROM ariba.integration.core.IntegrationEventLog
WHERE AdapterName LIKE '%PaymentExport_CSV'
AND RecordsExported = 0
AND (
  (CurrentTime() - StartRunDate) <= 1 OR
  (CurrentTime() - EndRunDate) <= 1
)
Order by 3 desc`;
            } else {
                return `SELECT DISTINCT UniqueName as "Id",
UniqueName,
StatusString,
CreateDate,
ApprovedDate,
'Awaiting processing' ProcessedStateString
FROM ariba.receiving.core.Receipt
WHERE StatusString = 'Approved'
AND ProcessedState = 1
AND UniqueName IN (${namesStr})
ORDER BY ApprovedDate DESC`;
            }
        }

        // Copy query to clipboard
        function copyQuery() {
            navigator.clipboard.writeText(currentQuery).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.classList.add('copied');
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Copied!
                `;
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        Copy
                    `;
                }, 2000);
            });
        }

        // Copy product specialist to clipboard
        function copyProductSpecialist() {
            if (!currentProductSpecialist) return;
            navigator.clipboard.writeText(currentProductSpecialist).then(() => {
                showCopySuccess('copyPsBtn');
            });
        }

        // Copy email subject to clipboard
        function copySubject() {
            navigator.clipboard.writeText(currentEmailSubject).then(() => {
                showCopySuccess('copySubjectBtn');
            });
        }

        // Copy email body to clipboard
        function copyEmailBody() {
            navigator.clipboard.writeText(currentEmailBody).then(() => {
                const btn = document.getElementById('copyEmailBtn');
                btn.classList.add('copied');
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Copied!
                `;
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        Copy
                    `;
                }, 2000);
            });
        }

        // Copy contacts to clipboard
        function copyContacts() {
            if (!currentContacts) return;
            navigator.clipboard.writeText(currentContacts).then(() => {
                showCopySuccess('copyContactsBtn');
            });
        }

        // Open email in Outlook (mailto)
        function openInOutlook() {
            const notificationEmail = 'itsm.notification-service@sap.com';
            let toRecipients = '';
            let ccRecipients = '';

            if (hasCustomerContacts && currentContacts) {
                // Customer contacts as recipients, PS and notification service in CC
                toRecipients = currentContacts;
                ccRecipients = currentProductSpecialist 
                    ? `${currentProductSpecialist}, ${notificationEmail}`
                    : notificationEmail;
            } else {
                // Product specialist as recipient, notification service in CC
                toRecipients = currentProductSpecialist || '';
                ccRecipients = notificationEmail;
            }

            // Construct mailto URL
            const subject = encodeURIComponent(currentEmailSubject);
            const body = encodeURIComponent(currentEmailBody);
            const cc = encodeURIComponent(ccRecipients);
            
            let mailtoUrl = `mailto:${toRecipients}?subject=${subject}&body=${body}&cc=${cc}`;
            
            // Open the mailto link
            window.location.href = mailtoUrl;
        }

        // Show copy success animation for small buttons
        function showCopySuccess(btnId) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            btn.classList.add('copied');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            `;
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = originalHtml;
            }, 1500);
        }

        // Render data table
        function renderDataTable(data) {
            const table = document.getElementById('dataTable');
            if (!data || data.length === 0) {
                table.innerHTML = '<tr><td>No data available</td></tr>';
                return;
            }

            const headers = Object.keys(data[0]);
            let html = '<thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(h => html += `<td>${row[h] || ''}</td>`);
                html += '</tr>';
            });
            html += '</tbody>';
            
            table.innerHTML = html;
        }

        // Toggle data table
        function toggleDataTable() {
            const content = document.getElementById('dataTableContent');
            const icon = document.getElementById('expandIcon');
            content.classList.toggle('expanded');
            icon.style.transform = content.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0)';
        }
    </script>
</body>
</html>

